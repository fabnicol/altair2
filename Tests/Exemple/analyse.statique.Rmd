
```{r }
# Copyright Cour des comptes, 2017
# Contributeur :
# Fabrice Nicol, ann?es 2012 ? 2017
# fabrice.nicol@crtc.ccomptes.fr
# 
# Ce logiciel est un programme informatique servant ? extraire et analyser les fichiers de paye
# produits au format sp?cifi? par l'annexe de la convention-cadre nationale de d?mat?rialisation
# en vigueur ? compter de l'ann?e 2008.
# 
# Ce logiciel est r?gi par la licence CeCILL soumise au droit fran?ais et
# respectant les principes de diffusion des logiciels libres. Vous pouvez
# utiliser, modifier et/ou redistribuer ce programme sous les conditions
# de la licence CeCILL telle que diffus?e par le CEA, le CNRS et l'INRIA
# sur le site "http://www.cecill.info".
# 
# En contrepartie de l'accessibilit? au code source et des droits de copie,
# de modification et de redistribution accord?s par cette licence, il n'est
# offert aux utilisateurs qu'une garantie limit?e. Pour les m?mes raisons,
# seule une responsabilit? restreinte p?se sur l'auteur du programme, le
# titulaire des droits patrimoniaux et les conc?dants successifs.
# 
# A cet ?gard l'attention de l'utilisateur est attir?e sur les risques
# associ?s au chargement, ? l'utilisation, ? la modification et/ou au
# d?veloppement et ? la reproduction du logiciel par l'utilisateur ?tant
# donn? sa sp?cificit? de logiciel libre, qui peut le rendre complexe ?
# manipuler et qui le r?serve donc ? des d?veloppeurs et des professionnels
# avertis poss?dant des connaissances informatiques approfondies. Les
# utilisateurs sont donc invit?s ? charger et tester l'ad?quation du
# logiciel ? leurs besoins dans des conditions permettant d'assurer la
# s?curit? de leurs syst?mes et ou de leurs donn?es et, plus g?n?ralement,
# ? l'utiliser et l'exploiter dans les m?mes conditions de s?curit?.
# 
# Le fait que vous puissiez acc?der ? cet en-t?te signifie que vous avez
# pris connaissance de la licence CeCILL, et que vous en avez accept? les
# termes.
# 
# 

# Conversion en Rmd: spin(..., knit = FALSE)  dans l'encodage du syst?me (convertir ce fichier en UTF-8 sous linux)

# On revient ? une analyse des r?mun?rations qui r?inclut tous les personnels (vacataires, ?lus, inactifs, annexes)

Analyse.remunerations.exercice <- Analyse.remunerations[Ann?e == ann?e]     
```

# `r chapitre`. R?mun?rations brutes : analyse pour l'exercice `r ann?e`      
## `r chapitre`.1 Masse salariale brute de l'ensemble des agents     

```{r }
masses.personnels <- Analyse.remunerations.exercice[Statut != "ELU",
                                                    .(Montant.brut.annuel = sum(Montant.brut.annuel, na.rm = TRUE),                                                                                       r?mun?ration.indemnitaire.imposable = sum(r?mun?ration.indemnitaire.imposable, na.rm = TRUE),
                                                      indemnit?s.?lu = sum(indemnit?s.?lu, na.rm = TRUE),
                                                      total.lignes.paie = sum(total.lignes.paie, na.rm = TRUE),
                                                      acomptes = sum(acomptes, na.rm = TRUE))]
```

### Cumuls des r?mun?rations brutes pour l'exercice `r ann?e`      
 
*Personnels (hors ?lus)*     
 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
essayer({
Tableau.vertical2(c("Agr?gats",
                    "k&euro;"),
                  c("Brut annuel (bulletins)",
                    "Brut annuel (lignes) :",
                    "\\ dont \\ Primes :",
                    "\\ dont \\ Autres r?mun?rations",
                    "Part de primes en %"),
                  c(masses.personnels$Montant.brut.annuel,
                    masses.personnels$total.lignes.paie,
                    masses.personnels$r?mun?ration.indemnitaire.imposable,
                    masses.personnels$acomptes,
                    masses.personnels$r?mun?ration.indemnitaire.imposable/masses.personnels$Montant.brut.annuel * 100))
}, "")
```

 
**D?finitions :**

 *Brut annuel (bulletins)*   : somme du champ *Brut*    
 *Brut annuel (lignes)*      : somme du champ *Montant* des lignes de paye, dont :    
 *Primes*                    : indemnit?s sauf remboursements, certaines IJSS, indemnit?s d'?lu le cas ?ch?ant, Suppl?ment familial de traitement et Indemnit? de r?sidence        
 *Autres r?mun?rations*      : acomptes, retenues sur brut, r?mun?rations diverses, rappels   
 
**Tests de coh?rence**

Somme des r?mun?rations brutes vers?es aux personnels (non ?lus) :  
 
 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
essayer({
Tableau.vertical2(c("Agr?gats",
                    "k&euro;"),
                  c("Bulletins de paie ",
                    "Lignes de paie ",
                    "Diff?rence "),
                  c(masses.personnels$Montant.brut.annuel,
                    masses.personnels$total.lignes.paie,
                    masses.personnels$Montant.brut.annuel -
                      masses.personnels$total.lignes.paie))
}, "")
```


? comparer aux soldes des comptes 641 et 648 du compte de gestion.

  
## `r chapitre`.2 Masse salariale brute des fonctionnaires

*Cette section concerne les personnels fonctionnaires titulaires et stagiaires*  


```{r }
filtre.fonctionnaire <<- function (X) X[ !is.na(X)  & X > minimum.positif ]

AR <- Analyse.remunerations.exercice[Statut == "TITULAIRE" | Statut == "STAGIAIRE", 
                                     ..colonnes.s?lectionn?es]

attach(AR, warn.conflicts = FALSE)
source("histogrammes.R", encoding = encodage.code.source)

detach(AR)
```

   
**Nota :**   
*EQTP : Equivalent temps plein = 12 . moyenne du ratio ratio r?mun?ration / quotit?*  
   
**Effectif : `r nrow(AR)`**

**Tests de coh?rence**

```{r }
if (nrow(AR) > 0) {
  masses.fonct <- AR[ , lapply(.(Montant.brut.annuel, r?mun?ration.indemnitaire.imposable, total.lignes.paie, acomptes), sum, na.rm = TRUE)]
  
} else {
  masses.fonct <- c(0,0) 
}
```

Somme des r?mun?rations brutes vers?es aux personnels titulaires et stagiaires :

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
essayer({
Tableau.vertical2(c("Agr?gats",
                    "k&euro;"),
                  c("Brut annuel (bulletins)",
                    "Brut annuel (lignes) : ",
                    "\\ dont \\ \\ primes :",
                    "\\ dont \\ autres r?mun?rations :",
                    "Part de primes en %"),
                  c(masses.fonct[[1]],  
                    masses.fonct[[3]],
                    masses.fonct[[2]],
                    masses.fonct[[4]],
                    masses.fonct[[2]]/masses.fonct[[1]] * 100))
}, "")
```


**D?finitions :**

 *Brut annuel (bulletins)*   : somme du champ *Brut*   
 *Brut annuel (lignes)*      : somme du champ *Montant* des lignes de paye, dont :   
 *Primes*                    : indemnit?s sauf remboursements, certaines IJSS, Suppl?ment familial de traitement et Indemnit? de r?sidence       
 *Autres r?mun?rations*      : acomptes, retenues sur brut, r?mun?rations diverses, rappels   

**Tests de coh?rence**

Somme des r?mun?rations brutes vers?es aux personnels (fonctionnaires) :

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
essayer({
Tableau.vertical2(c("Agr?gats",
                    "k&euro;"),
                  c("Bulletins de paie ",
                    "Lignes de paie ",
                    "Diff?rence "),
                  c(masses.fonct[[1]],  # Brut
                    masses.fonct[[3]],  # lignes
                    masses.fonct[[1]] -
                      masses.fonct[[3]]))

},"")
```


A comparer aux soldes des comptes 6411, 6419 et 648 du compte de gestion.

**Formation et distribution du salaire brut moyen par t?te (SMPT) en EQTP pour l'ann?e `r ann?e`**     
 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
R?sum?(c("Traitement indiciaire",
         "Primes",
         "Autres r?mun?rations",
         "Quotit?",
         "Effectif"),
       AR[Grade != "V" & Grade != "A" & Statut != "ELU"
          & Filtre_actif == TRUE
          & Filtre_annexe == FALSE,
             .(traitement.indiciaire,
               r?mun?ration.indemnitaire.imposable,
               acomptes,
               quotit?.moyenne)],
       
       extra = "length")
```

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
R?sum?(c("Total lignes hors rappels",
         "Total brut",
         "SMPT brut en EQTP",
         "Part indemnitaire",
         "Quotit?",
         "Effectif"),
       AR[Grade != "V" & Grade != "A" & Statut != "ELU"
          & Filtre_actif == TRUE
          & Filtre_annexe == FALSE,
          .(total.lignes.paie,
             Montant.brut.annuel,
             Montant.brut.annuel.eqtp,
             part.r?mun?ration.indemnitaire,
             quotit?.moyenne)],
       extra = "length")
```

  
*Hors vacataires identifi?s, assistantes maternelles, ?lus locaux et pour les postes actifs non annexes*  

**Cat?gorie A**


```{r }
ARA <- data.table::data.table(NULL)
ARB <- data.table::data.table(NULL)
ARC <- data.table::data.table(NULL)
```

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
if (analyse.par.cat?gorie) {

  ARA <- AR[Cat?gorie == "A" & Grade != "V" & Grade != "A" & Statut != "ELU" 
            & Filtre_actif == TRUE
            & Filtre_annexe == FALSE, ]
  
  R?sum?(c("Traitement indiciaire",
           "Primes",
           "Autres r?mun?rations",
           "Quotit?"),
         ARA[ , .(traitement.indiciaire,
                  r?mun?ration.indemnitaire.imposable,
                  acomptes,
                  quotit?.moyenne)])
} else {
  cat("Pas de statistiques par cat?gorie.\n")
}
```


 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
if (analyse.par.cat?gorie) {  
  R?sum?(c("Total r?mun?rations", 
           "Total r?mun?rations EQTP", 
           "Part indemnitaire",
           "Quotit?"),
         ARA[ , .(Montant.brut.annuel,
                  Montant.brut.annuel.eqtp,
                  part.r?mun?ration.indemnitaire,
                  quotit?.moyenne)])

} else {
  cat("Pas de statistiques par cat?gorie.\n")
}
```


**Effectif : `r nrow(ARA)`**  

**Cat?gorie B**

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
if (analyse.par.cat?gorie) {
  ARB <- AR[Cat?gorie == "B" & Grade != "V" & Grade != "A" & Statut != "ELU"
            & Filtre_actif == TRUE
            & Filtre_annexe == FALSE, ]
  
  R?sum?(c("Traitement indiciaire",
           "Primes",
           "Autres r?mun?rations",
           "Quotit?"),
         ARB[, .(traitement.indiciaire,
                 r?mun?ration.indemnitaire.imposable,
                 acomptes,
                 quotit?.moyenne)])
} else {
  cat("Pas de statistiques par cat?gorie.\n")
}
```


 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
if (analyse.par.cat?gorie) {
  
  R?sum?(c("Total r?mun?rations",
           "Total r?mun?rations EQTP",
           "Part de la r?mun?ration indemnitaire",
           "Quotit?"),
         ARB[, .(Montant.brut.annuel,
                 Montant.brut.annuel.eqtp,
                 part.r?mun?ration.indemnitaire,
                 quotit?.moyenne)])
} else {
  cat("Pas de statistiques par cat?gorie.\n")
}
```


**Effectif : `r nrow(ARB)`**

**Cat?gorie C**

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
if (analyse.par.cat?gorie) {
  ARC <- AR[Cat?gorie == "C" & Grade != "V" & Grade != "A" & Statut != "ELU" 
            & Filtre_actif == TRUE
            & Filtre_annexe == FALSE, ]
  
  R?sum?(c("Traitement indiciaire",
           "Primes",
           "Autres r?mun?rations",
           "Quotit?"),
         ARC[ , .(traitement.indiciaire,
                  r?mun?ration.indemnitaire.imposable,
                  acomptes,
                  quotit?.moyenne)])
} else {
  cat("Pas de statistique par cat?gorie.\n")
}
```


 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
if (analyse.par.cat?gorie) {
  
  R?sum?(c("Total r?mun?rations",
           "Total r?mun?rations EQTP",
           "Part de la r?mun?ration indemnitaire",
           "Quotit?"),
         ARC[ , .(Montant.brut.annuel,
                  Montant.brut.annuel.eqtp,
                  part.r?mun?ration.indemnitaire,
                  quotit?.moyenne) ])
} else {
  cat("Pas de statistiques par cat?gorie.\n")
}
```

**Effectif : `r nrow(ARC)`**


######      <br>

## `r chapitre`.3 Contractuels, vacataires et stagiaires inclus   
  
*Les assistantes maternelles et les vacataires sont ici inclus, pour les postes non annexes*   


```{r }
attach(Analyse.remunerations.exercice, warn.conflicts=FALSE)
temp <- r?mun?ration.indemnitaire.imposable.eqtp[Statut != "ELU"
                                                 & Statut != "TITULAIRE"
                                                 & Statut != "STAGIAIRE"
                                                 & Filtre_actif == TRUE
                                                 & Filtre_annexe == FALSE
                                                 & r?mun?ration.indemnitaire.imposable.eqtp > 1000] / 1000

if (longueur.non.na(temp) > 0)
  hist(temp,
       xlab = "R?mun?ration indemnitaire brute imposable en milliers d'euros EQTP\n",
       ylab = "Effectif",
       xlim = c(0, 40),
       main = "R?mun?ration annuelle totale des contractuels en " %+% ann?e,
       col = "red",
       nclass = 50)
```

  
**Nota :**
Ne sont retenues que les r?mun?rations sup?rieures ? 1 000 k&euro;.
Les ?lus ne sont pas pris en compte.
  

```{r }
temp <- positive(acomptes)

detach(Analyse.remunerations.exercice)

if (longueur.non.na(temp))
  hist(temp,
       xlab = "En euros :\n divers",
       ylab = "Effectif",
       xlim = c(0, 5000),
       main = "Autres r?mun?rations en " %+% ann?e,
       nclass = 50,
       col = "grey")
```



```{r }
AR <- Analyse.remunerations.exercice[Statut != "ELU"
                                             &  Statut != "TITULAIRE"
                                             &  Statut != "STAGIAIRE"
                                             & Filtre_actif == TRUE
                                             & Filtre_annexe == FALSE,
                                             ..colonnes.s?lectionn?es]
```

  
**Formation et distribution du salaire brut moyen par t?te (SMPT) en EQTP pour l'ann?e `r ann?e`**     
  
 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
R?sum?(c("Primes",
         "Autres r?mun?rations",
         "Quotit?",
         "Effectif"),
       AR[ , .(r?mun?ration.indemnitaire.imposable,
               acomptes,
               quotit?.moyenne)],
       extra = "length")
```

 
&nbsp;*Tableau `r incr?ment()`*   
   

```{r }
R?sum?(c("Total r?mun?rations",
         "Total r?mun?rations EQTP",
         "Quotit?",
         "Effectif"),
       AR[ , .(Montant.brut.annuel, Montant.brut.annuel.eqtp, quotit?.moyenne)],
       extra = "length")
```



```{r }
# pour ann?e fin #

rm(Analyse.remunerations.exercice)


################  Tableaux du guide d'enqu?te ################################
```

