# Copyright Cour des comptes, 2017
# Contributeur :
# Fabrice Nicol, années 2012 à 2017
# fabrice.nicol@crtc.ccomptes.fr
# 
# Ce logiciel est un programme informatique servant à extraire et analyser les fichiers de paye
# produits au format spécifié par l'annexe de la convention-cadre nationale de dématérialisation
# en vigueur à compter de l'année 2008.
# 
# Ce logiciel est régi par la licence CeCILL soumise au droit français et
# respectant les principes de diffusion des logiciels libres. Vous pouvez
# utiliser, modifier et/ou redistribuer ce programme sous les conditions
# de la licence CeCILL telle que diffusée par le CEA, le CNRS et l'INRIA
# sur le site "http://www.cecill.info".
# 
# En contrepartie de l'accessibilité au code source et des droits de copie,
# de modification et de redistribution accordés par cette licence, il n'est
# offert aux utilisateurs qu'une garantie limitée. Pour les mêmes raisons,
# seule une responsabilité restreinte pèse sur l'auteur du programme, le
# titulaire des droits patrimoniaux et les concédants successifs.
# 
# A cet égard l'attention de l'utilisateur est attirée sur les risques
# associés au chargement, à l'utilisation, à la modification et/ou au
# développement et à la reproduction du logiciel par l'utilisateur étant
# donné sa spécificité de logiciel libre, qui peut le rendre complexe à
# manipuler et qui le réserve donc à des développeurs et des professionnels
# avertis possédant des connaissances informatiques approfondies. Les
# utilisateurs sont donc invités à charger et tester l'adéquation du
# logiciel à leurs besoins dans des conditions permettant d'assurer la
# sécurité de leurs systèmes et ou de leurs données et, plus généralement,
# à l'utiliser et l'exploiter dans les mêmes conditions de sécurité.
# 
# Le fait que vous puissiez accéder à cet en-tête signifie que vous avez
# pris connaissance de la licence CeCILL, et que vous en avez accepté les
# termes.
# 
# 

an <- as.numeric(format(Sys.time(), "%Y"))

if (début.période.sous.revue < 2008) {
  
  cat("Ce programme ne peut pas traiter les périodes sous revue commençant avant le 1er janvier 2008. Ces années seront écartées.")
  extraire.années <- TRUE
  début.période.sous.revue <- 2008
}
  
# Période couverte : 2008-2017 inclus

PointIM <- matrix(c(
                    54.4113,             # 2008 01
                    54.4113,             # 2008 02
                    rep.int(54.6834, 7), # 2008 3-9 
                    rep.int(54.8475, 9), # 2008 10-12 et 2009 1-6
                    rep.int(55.1217, 3), # 2009 6-9
                    rep.int(55.2871, 9), # 2009 10-12 et 2010 1-6
                    rep.int(55.5635, 72),# 2010 7 -> 2016 6  (6 années de blocage)
       				rep.int(55.8969, 6),# 2016 7 -> 2016 12
       				55.8969, # 2017 
       				rep.int(56.2323,11),
       				rep.int(56.2323,12)),
       				
            				# insérer ici la valeur courante du mpoint d'indice annuel
            				# par exemple pour 56 € par point/an :
            				# rep.int(56, 12)
            				# si passage à 56.5 au 1er juillet:
            				# rep.int(56, 6)
            				# rep.int(56.5, 6)
            				
                    ncol = 12, 
            				byrow = TRUE)

limite_inm <- 2008 + nrow(PointIM)

if (an >= limite_inm) {
  
  cat("AVERTISSEMENT : Il faut actualiser la matrice PointIM du fichier point.im.R comme indiqué en commentaires en rajoutant la valeur annuelle du point d'indice net pour les années après", limite_inm)
  
  if (fin.période.sous.revue >= limite_inm) {
    
    cat("ERREUR : La période sous revue dépasse la valeur limite du tableau en référence du point d'indice net. Actualiser ce tableau (fichier point.im.R) et relancer", limite_inm - 1)
    if (fin.période.sous.revue > limite_inm) {
      cat("Il faut rajouter la période", limite_inm, " - ",  fin.période.sous.revue)
    } else {
      cat("Il faut rajouter l'année", limite_inm)
    }
    
    cat("Pour continuer à s'exécuter le programme va écarter les années ci-dessus mentionnées...")
    
    extraire.années <- TRUE
    fin.période.sous.revue <- limite_inm - 1
  }
}

PointMensuelIM <- PointIM / 12

PointMensuelIMMoyen <- apply(PointMensuelIM, 1, mean)

valeur.point.inm.pivot <- round(PointMensuelIMMoyen, 1)     

# année >= 2008 et année <= 2016

# pour avoir la valeur du point d'indice retrancher 2007 à l'année :
#   PointIM[année - 2007, mois]

# 1/01/2015	55.5635	
# 1/01/2014	55.5635	
# 1/01/2013	55.5635	
# 1/02/2012	55.5635	
# 1/07/2011	55.5635	
# 1/07/2010	55.5635	
# 1/10/2009	55.2871	
# 1/07/2009	55.1217	
# 1/10/2008	54.8475	
# 1/03/2008	54.6834	
# 1/02/2007	54.4113	
