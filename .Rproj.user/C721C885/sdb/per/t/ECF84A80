{
    "collab_server" : "",
    "contents" : "\n#'---\n#'title: false\n#'author: false\n#'date: false\n#'output:\n#'html_document:\n#'css: style.css\n#'---\n#'   \n#'![Image_Altair](Altair.png)\n#'   \n#'   \n#'# Démonstrateur Altaïr version 15.02   \n\n#+ echo = FALSE, warning = TRUE, message = FALSE\n\n# comportement global du programme\n\n# Lorsque l'on n'a que une ou deux années, mettre étudier.variations à FALSE\n# Lorsque l'on n'étudie pas une base Xémélios, mettre étudier.tests.statutaires à FALSE\n\n\nlibrary(compiler)\ninvisible(setCompilerOptions(suppressAll = TRUE))\ninvisible(enableJIT(1))\n\noptions(warn = -1, verbose = FALSE, OutDec = \",\", datatable.verbose = FALSE)\n\nencodage.code.source <- \"ISO-8859-1\"\n\ncurrentDir              <- getwd()\ngénérer.rapport         <- (basename(currentDir) != \"altair\") \n\n# dans cet ordre\n\ntry(setwd(\"Tests/Exemple\"), silent = TRUE)\n\nsource(\"syspaths.R\", encoding = encodage.code.source)\nsource(\"prologue.R\", encoding = encodage.code.source)\n\nif (corriger.environnement.système) {\n  \n  invisible(Sys.setenv(PATH = paste0(Sys.getenv(\"PATH\"), \"c:\\\\Users\\\\Public\\\\Dev\\\\altair\\\\texlive\\\\miktex\\\\bin\\\\x64;\")))\n  \n}\n\n\nsource(file.path(chemin.dossier, \"bibliotheque.fonctions.paie.R\"), encoding = encodage.code.source)\nsource(\"import.R\", encoding = encodage.code.source)\n\n\n#'\n#'<p class = \"centered\"><b>Exercices `r paste(début.période.sous.revue, \"à\", fin.période.sous.revue)` </b></p>\n#'<p class = \"author\">Fabrice Nicol</h1>\n#'\n#+ echo = FALSE\n#'`r format(Sys.Date(), \"%a %d %b %Y\")`\n#'    \n\n\ncat(\"\\nLa durée du travail prise en compte dans la base de données est de \", nb.heures.temps.complet, \" h par mois.\\n\")  \nif (nb.heures.temps.complet > 1.1 * 151.67 || nb.heures.temps.complet < 0.9 * 151.67)  {\n  semaine.de.travail <<- nb.heures.temps.complet * 12 / 52\n  \n  cat(\"\\nAttention !\\nLe temps de travail hebdomadaire s'écarte significativement de la durée légale : \", \n      round(semaine.de.travail,1), \" h par semaine.\\n\")\n}\n\nsource(\"analyse.rémunérations.R\", encoding = encodage.code.source)\n\n########### Démographie ########################\n\nincrémenter.chapitre()\n\n#'# `r chapitre`. Statistiques de population\n#'\n#'### `r chapitre`.1 Effectifs\n\nliste.années <- as.character(période)\n\n# Rappel Analyse.variations.par.exercice comprend uniquement les actifs non annexes non assist. mat., non vacataires, non élus.\n\neffectifs <- lapply(période,\n                    function(x) {\n                      A <- Bulletins.paie[Année == x, \n                                          .(Matricule, Statut, permanent, quotité, nb.mois, Grade)]\n                      \n                      E <- unique(A[ , .(Matricule, permanent)], by = NULL)\n                      ETP <- unique(Bulletins.paie[Année == x, \n                                                   .(quotité, Matricule, Statut, permanent, Mois, nb.mois)],\n                                    by = NULL)\n                      F <- E[permanent == TRUE, ]\n                      G <- unique(A[Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\", .(Matricule, permanent)],\n                                  by = NULL)\n                      H <- G[permanent == TRUE, ]\n                      I <- unique(A[Statut == \"ELU\", .(Matricule, permanent)],\n                                  by = NULL)\n                      J <- I[permanent == TRUE, ]\n                      K <- unique(A[Statut != \"TITULAIRE\" & Statut != \"STAGIAIRE\" & Grade == \"V\", .(Matricule, permanent)],\n                                  by = NULL)\n                      L <- unique(A[Grade == \"A\", .(Matricule, permanent)],\n                                  by = NULL)\n                      postes.non.actifs <- unique(Analyse.rémunérations[Statut != \"ELU\"\n                                                                        & Filtre_actif == FALSE\n                                                                        & Année == x,\n                                                                          Matricule])\n                      postes.annexes <- unique(Analyse.rémunérations[Statut != \"ELU\"\n                                                                     & Filtre_non_annexe == FALSE\n                                                                     & Année == x,\n                                                                       Matricule])\n                      postes.actifs.non.annexes <- unique(Analyse.rémunérations[Statut != \"ELU\"\n                                                                                & Filtre_actif_non_annexe == TRUE\n                                                                                & Année == x,\n                                                                                  Matricule])\n                      postes.non.titulaires <- unique(Analyse.variations.par.exercice[Statut == \"NON_TITULAIRE\" \n                                                                                      & Année ==x, \n                                                                                        Matricule])\n                      \n                      c(nrow(E), \n                        nrow(F),\n                        nrow(G),\n                        nrow(H),\n                        length(postes.non.titulaires),\n                        nrow(I),\n                        nrow(J),\n                        nrow(K),\n                        nrow(L),\n                        length(postes.non.actifs),\n                        length(postes.annexes),\n                        length(postes.actifs.non.annexes),\n                        ETP[Statut != \"ELU\" , sum(quotité/nb.mois, na.rm=TRUE)],\n                        ETP[Statut != \"ELU\" , sum(quotité, na.rm=TRUE)] / 12,\n                        ETP[Matricule %chin% unique(Analyse.variations.par.exercice[est.rmpp == TRUE\n                                                                                    & Année == x,\n                                                                                    Matricule]),\n                            sum(quotité, na.rm=TRUE)] / 12,\n                        ETP[(Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\")\n                            & Matricule %chin% unique(Analyse.variations.par.exercice[Statut == \"TITULAIRE\"\n                                                                                      | Statut == \"STAGIAIRE\",\n                                                                                         Matricule]),\n                              sum(quotité, na.rm=TRUE)] / 12,\n                        ETP[Statut == \"TITULAIRE\"\n                            & permanent == TRUE \n                            & Matricule %chin% unique(Analyse.variations.par.exercice[permanent == TRUE\n                                                                             & Statut == \"TITULAIRE\"\n                                                                             & temps.complet == TRUE\n                                                                             & Année == x,\n                                                                             Matricule]),\n                              sum(quotité, na.rm=TRUE)] / 12,\n                        ETP[Statut == \"NON_TITULAIRE\" \n                            & Matricule %chin% postes.non.titulaires,  \n                              sum(quotité, na.rm=TRUE)] / 12,\n                        ETP[Statut == \"AUTRE_STATUT\"  \n                            & Matricule %chin% unique(Analyse.rémunérations[Statut == \"AUTRE_STATUT\",\n                                                                                    Matricule]),\n                              sum(quotité, na.rm=TRUE)] / 12,\n            \t\t\t\t\t\tETP[Matricule %chin% postes.non.actifs, sum(quotité, na.rm=TRUE)] / 12,\n            \t\t\t\t\t\tETP[Matricule %chin% postes.annexes, sum(quotité, na.rm=TRUE)] / 12,\n                        ETP[Matricule %chin% postes.actifs.non.annexes, sum(quotité, na.rm=TRUE)] / 12)\t\t\t\t\t\t\t\n                     })\n\nfor (i in 1:length(effectifs)) names(effectifs[[i]]) <- c(\"Effectifs\", \n                                                          \"Effectifs_12\",\n                                                          \"Effectifs_12_fonct\",\n                                                          \"Effectifs_12_fonct\",\n                                                          \"Effectifs_nontit\",\n                                                          \"Effectifs_élus\",\n                                                          \"Effectifs_12_élus\",\n                                                          \"Effectifs_vac\",\n                                                          \"Effectifs_am\",\n                                                          \"Effectifs_non.actifs\",\n                                                          \"Effectifs_annexes\",\n                                                          \"Effectifs_actifs_non.annexes\",\n                                                          \"ETP\",\n                                                          \"ETPT\",\n                                                          \"ETPT_pp\", \n                                                          \"ETPT_fonct\",\n                                                          \"Tit_12_100\",\n                                                          \"ETPT_nontit\", \n                                                          \"ETPT_autre\",\n                                                          \"ETPT_non_actif\",\n                                                          \"ETPT_annexe\",\n                                                          \"ETPT_actif_nonannexe\")\n \neffectifs.locale <- lapply(effectifs, \n                           function(x) formatC(x, big.mark = \" \", format=\"f\", digits=1, decimal.mark=\",\"))\n\ntableau.effectifs <- as.data.frame(effectifs.locale,\n                                   row.names = c(\"Total effectifs (a)\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont présents 12 mois\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont fonctionnaires (b)\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont fonct. présents 12 mois\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont non titulaires\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont élus\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont élus présents 12 mois\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont vacataires détectés (c)\",\n                                                 \"&nbsp;&nbsp;&nbsp;dont assistantes maternelles détectées (c)\",\n                                                 \"Postes non actifs (g)\",\n                                                 \"Postes annexes (g)\",\n                                                 \"Postes actifs non annexes (g)\",\n                                                 \"Total ETP/année (d)\",\n                                                 \"Total ETPT/année (e)\",\n                                                 \"Total ETPT/année personnes en place (f)(g)\",\n                                                 \"Total ETPT/année fonctionnaires (g)\",\n                                                 \"Total ETPT/année titulaires à temps complet (g)\",\n                                                 \"Total ETPT non titulaires (g)\",\n                                                 \"Total ETPT autre statut\",\n                                                 \"Total ETPT postes non actifs (g)\",\n                                                 \"Total ETPT postes annexes (g)\",\n                                                 \"Total ETPT postes actifs non annexes (g)\"))\n\nnames(tableau.effectifs) <- liste.années\nnames(effectifs) <- liste.années\n#'  \n#  \n#'&nbsp;*Tableau `r incrément()`*   \n#            \nkable(tableau.effectifs, row.names = TRUE, align='c')\n#'\n#'**Nota:**   \n#'*(a) Nombre de matricules distincts ayant eu au moins un bulletin de paie dans l'année, en fonction ou non.Peut correspondre à des régularisations, des personnels hors position d'activité ou des ayants droit (reversion, etc.)*   \n#'*(b) Titulaires ou stagiaires*   \n#'*(c) Sur la base des libellés d'emploi et des libellés de lignes de paie. La détection peut être lacunaire*   \n#'*(d) ETP  : Equivalent temps plein = rémunération . quotité*  \n#'*(e) ETPT : Equivalent temps plein travaillé = ETP . 12/nombre de mois travaillés dans l'année*  \n#'*(f) Personnes en place : présentes en N et N-1 avec la même quotité, postes actifs et non annexes uniquement.*     \n#'*(g) Postes actifs et non annexes :* voir [Compléments méthodologiques](Docs/méthodologie.pdf)    \n#'*&nbsp;&nbsp;&nbsp;Un poste actif est défini par au moins un bulletin de paie comportant un traitement positif pour un volume d'heures de travail mensuel non nul.*             \n#'*&nbsp;&nbsp;&nbsp;Un poste non annexe est défini comme la conjonction de critères horaires et de revenu sur une année. La période minimale de référence est le mois.*   \n#'*Les dix dernières lignes du tableau sont calculées en ne tenant pas compte des élus.*      \n#'   \n#'[Lien vers la base des effectifs](Bases/Effectifs/tableau.effectifs.csv)\n#'\n#'\nmessage(\"Statistiques de démographie réalisées.\")\n\n#'### `r chapitre`.2 Pyramide des âges, personnels non élus\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \nRésumé(c(\"Âge des personnels <br>au 31/12/\" %+% début.période.sous.revue,\n         \"Effectif\"),\n       années.total.hors.élus.début,\n       extra = \"length\",\n       align = 'c')\n#'  \nif (longueur.non.na(années.total.hors.élus.début) > 0)\n  hist(années.total.hors.élus.début,\n       xlab = \"Âge au 31 décembre \" %+% début.période.sous.revue,\n       xlim = c(18, 75),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des personnels (non élus)\",\n       col = \"blue\",\n       nclass = 50)\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels <br>au 31/12/\" %+% fin.période.sous.revue,\n         \"Effectif\"),\n       années.total.hors.élus,\n       extra = \"length\",\n       align = 'c')\n\n#'  \n#'  \nif (longueur.non.na(années.total.hors.élus) > 0)\n  hist(années.total.hors.élus,\n       xlab = \"Âge au 31 décembre \" %+% fin.période.sous.revue,\n       xlim = c(18, 75),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des personnels (non élus)\",\n       col = \"blue\",\n       nclass = 50)\n\n#'\n#'### `r chapitre`.3 Pyramide des âges, personnels non titulaires\n\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels non titulaires<br>au 31/12/\" %+% début.période.sous.revue,\n         \"Effectif\"),\n       années.total.nontit.début,\n       extra = \"length\",\n       align = 'c')\n\n#'  \nif (longueur.non.na(années.total.nontit.début) > 0)\n  hist(années.total.nontit.début,\n       xlab = \"Âge au 31 décembre \" %+% début.période.sous.revue,\n       xlim = c(18, 75),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des personnels non titulaires\",\n       col = \"blue\",\n       nclass = 50)\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels non titulaires<br>au 31/12/\" %+% fin.période.sous.revue,\n         \"Effectif\"),\n       années.total.nontit,\n       extra = \"length\",\n       align = 'c')\n\n\t   \nif (longueur.non.na(années.total.nontit) > 0)\n  hist(années.total.nontit,\n       xlab = \"Âge au 31 décembre \" %+% fin.période.sous.revue,\n       xlim = c(18, 75),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des personnels non titulaires\",\n       col = \"blue\",\n       nclass = 50)\n\t   \n\t   \n#'  \n#'[Lien vers la base des âges](Bases/Effectifs/Bulletins.paie.nir.nontit.csv)  \n#'  \n#'\n#'\n#'### `r chapitre`.4 Pyramide des âges, personnels fonctionnaires stagiaires et titulaires\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels <br>au 31/12/\" %+% début.période.sous.revue,\n         \"Effectif\"),\n       années.fonctionnaires.début,\n       extra = \"length\",\n       align = 'c')\n\n#'  \n#'\n\nif (longueur.non.na(années.fonctionnaires.début) > 0)\n  hist(années.fonctionnaires.début,\n       xlab = \"Âge au 31 décembre \" %+% début.période.sous.revue,\n       xlim = c(18,68),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des fonctionnaires\",\n       col = \"navy\",\n       nclass = 50)\n\n#'  \n\n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels <br>au 31/12/\" %+% fin.période.sous.revue,\n         \"Effectif\"),\n       années.fonctionnaires,\n       extra = \"length\",\n       align = 'c')\n\n#'\n\nif (longueur.non.na(années.fonctionnaires) > 0)\n  hist(années.fonctionnaires,\n       xlab = \"Âge au 31 décembre \" %+% fin.période.sous.revue,\n       xlim = c(18,68),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des fonctionnaires\",\n       col = \"navy\",\n       nclass = 50)\n\n#'  \n#'[Lien vers la base des âges](Bases/Effectifs/Bulletins.paie.nir.fonctionnaires.csv)  \n#'  \n\n#'### `r chapitre`.5 Pyramide des âges, personnels permanents (titulaires, stagiaires et non titulaires)\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels <br>au 31/12/\" %+% début.période.sous.revue,\n         \"Effectif\"),\n       années.total.permanents.début,\n       extra = \"length\",\n       align = 'c')\n\n#'  \n\nif (longueur.non.na(années.total.permanents.début) > 0)\n  hist(années.total.permanents.début,\n       xlab = \"Âge au 31 décembre \" %+% début.période.sous.revue,\n       xlim = c(18,68),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des permanents\",\n       col = \"navy\",\n       nclass = 50)\n\n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Âge des personnels <br>au 31/12/\" %+% fin.période.sous.revue,\n         \"Effectif\"),\n       années.total.permanents,\n       extra = \"length\",\n       align = 'c')\n\n#'\n\nif (longueur.non.na(années.total.permanents) > 0)\n  hist(années.total.permanents,\n       xlab = \"Âge au 31 décembre \" %+% fin.période.sous.revue,\n       xlim = c(18,68),\n       ylab = \"Effectif\",\n       main = \"Pyramide des âges des permanents\",\n       col = \"navy\",\n       nclass = 50)\n\n#'  \n#'[Lien vers la base des âges](Bases/Effectifs/Bulletins.paie.nir.permanents.csv)  \n#'  \n\n#'### `r chapitre`.6 Effectifs des personnels par durée de service\n#'\n#'**Personnels en fonction (hors élus) des exercices `r début.période.sous.revue` à `r fin.période.sous.revue` inclus :**\n#'\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n\n\nTableau(c(\"Plus de 2 ans\",\n          \"Moins de 2 ans\",\n          \"Moins d'un an\",\n          \"Moins de six mois\"),\n        sum(Analyse.variations.synthèse$plus.2.ans, na.rm=TRUE),\n        sum(Analyse.variations.synthèse$moins.2.ans, na.rm=TRUE),\n        sum(Analyse.variations.synthèse$moins.1.an, na.rm=TRUE),\n        sum(Analyse.variations.synthèse$moins.six.mois, na.rm=TRUE))\n\n\n#'\n\nif (nrow(Analyse.variations.par.exercice) > 0)\n  qplot(factor(Année),\n        data = Analyse.variations.par.exercice,\n        geom = \"bar\",\n        fill = factor(!Analyse.variations.par.exercice$plus.2.ans),\n        main = \"Evolutions entre \" %+% début.période.sous.revue %+% \" et \" %+% fin.période.sous.revue,\n        xlab = étiquette.année,\n        ylab = \"Effectif\",\n        asp = 1.4)        +\n  scale_fill_discrete(name = \"Personnels (non élus) en fonction\",\n                      breaks = c(TRUE, FALSE),\n                      labels = c(\"Moins de deux ans\", \"Plus de deux ans\"))\n\n\n\n#'\n#'**Effectifs (hors élus)**   \n#'\n\neffectifs.var <- lapply(période,\n                        function(x) {\n\n                          E <- unique(Analyse.variations.par.exercice[Année == x , .(Matricule, plus.2.ans)], by=NULL)\n                          F <- E[plus.2.ans == TRUE]\n                          tot <- nrow(E)\n                          plus.2.ans <- nrow(F)\n                          résultat <- c(plus.2.ans, tot - plus.2.ans, tot)\n                          rm(E, F, tot, plus.2.ans)\n                          résultat\n                        })\n\neffectifs.var.locale <- lapply(effectifs.var, function(x) formatC(x, big.mark = \" \", format=\"f\", digits=0, decimal.mark=\",\"))\n\ntableau.effectifs.var <- as.data.frame(effectifs.var.locale, row.names = c(\"Plus de deux ans\", \"Moins de deux ans\", \"Total\"))\n\nnames(tableau.effectifs.var) <- liste.années\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nkable(tableau.effectifs.var, row.names = TRUE, align='c')\n#'\n#'\n#'**Nota :**\n#'*Personnels en place : ayant servi au moins deux années consécutives pendant la période.*     \n#'*Plus/moins de deux ans : plus/mois de 730 jours sur la période sous revue.*   \n#'\n\ncolonnes.sélectionnées <- c(\"traitement.indiciaire\",\n                            \"autres.rémunérations\",\n                            \"rémunération.indemnitaire.imposable\",\n                            \"rémunération.indemnitaire.imposable.eqtp\",\n                            \"total.lignes.paie\",\n                            \"Montant.brut.annuel\",\n                            \"Montant.brut.annuel.eqtp\",\n                            \"part.rémunération.indemnitaire\",\n                            \"Statut\",\n                            \"Grade\",\n                            \"Filtre_actif_non_annexe\",\n                            clé.fusion)\n\n\n########### Analyse statique des rémunérations ########################\n\ninvisible(lapply(années.analyse.statique, function(x) {\n                 année <<- x\n                 incrémenter.chapitre()\n                 if (! générer.rapport) {\n                   \n                   source('analyse.statique.R', encoding = encodage.code.source) \n                   \n                 } else {\n                                      \n                   cat(knit_child(text = readLines(file.path(chemin.dossier,'analyse.statique.Rmd'), encoding = encodage.code.source), quiet=TRUE), sep = '\\n')\n                 }\n               }))\n\n#'  \n#'[Lien vers la base des rémunérations](Bases/Rémunérations/Analyse.rémunérations.csv)  \n#'   \n\n########### Comparatif INSEE DGCL ###############################\n#'   \n#'## `r chapitre`.4 Comparaisons source INSEE/DGCL   \n#'   \n#'*Salaires annnuels moyens 2011 en EQTP (hors assistantes maternelles)*   \n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical2(c(\"Agrégat (&euro;)\", \"Salaires bruts 2011\", \"Salaires bruts 2012\", \"Salaires bruts 2013\"),\n                  c(\"Ensemble\", \"Titulaires\", \"Autres salariés\"),\n                  12 * c(2159, 2223, 1903),\n                  12 * c(2195, 2259, NA),\n                  12 * c(2218, 2287, 2030))\n\n#'   \n#'**Eléments de la rémunération brute pour les titulaires de la FPT entre 2010 et 2012**      \n#'   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical2(\n  c(\"Rém. annuelles\", \"2010\", \"Primes\", \"2011\", \"Primes\", \"2012\", \"Primes\", \"2013\", \"Primes\"),\n  c(\"Salaire brut\",\n    \"Traitement brut\",\n    \"Primes et rémunérations annexes\",\n    \"y compris IR et SFT\"),\n  c(26305, 20350,\t\"\", 5955),\n  c(\"\", \"22,6 %\", \"\", \"\" ),\n  c(26660, 20562, \"\", 6098),\n  c(\"\", \"22,9 %\", \"\", \"\" ),\n  c(12*2259, 12*1727, \"\", 12*532),\n  c(\"\", \"23,6 %\", \"\", \"\" ),\n  c(12*2287, 12*1755, \"\", 12*532),\n  c(\"\", \"23,6 %\", \"\", \"\" ))\n#'   \n#'*Champ : France. Salariés en équivalent-temps plein (EQTP) des collectivités territoriales (y compris bénéficiaires de contrats aidés, hors assistantes maternelles).*   \t\t\t\t\t\t\t\t\t\t\t\t\n#'*Les primes sont cumulées au supplément familial de traitement (SFT) et à l'indemnité de résidence (IR). Le cumul est rapporté à la rémunération brute totale.*    \n#'[Source INSEE](http://www.insee.fr/fr/ffc/ipweb/ip1486/ip1486.xls)    \n#'[Source DGCL](http://www.fonction-publique.gouv.fr/files/files/statistiques/rapports_annuels/2012-2013/xls/Vue3_1_Remunerations.xls)    \n#'[Source DGFIP PLF 2015](http://www.performance-publique.budget.gouv.fr/sites/performance_publique/files/farandole/ressources/2015/pap/pdf/jaunes/jaune2015_fonction_publique.pdf)   \n#'   \n\nincrémenter.chapitre()\n\n########### Analyse dynamique des rémunérations ########################\n#'\n#'# `r chapitre`. Rémunérations nettes : évolutions sur la période `r début.période.sous.revue` - `r fin.période.sous.revue`    \n#'\n#'Nombre d'exercices: `r durée.sous.revue`   \n#'  \n#'**Les données présentées dans cette section sont toutes relatives à des rémunérations nettes en équivalent temps plein (EQTP)**   \n#'Les élus, les vacataires et les assistantes maternelles ont été retirés de la population étudiée       \n#'Seuls sont considérés les postes actifs et non annexes   \n#'    \n#'*Nota :*   \n#'*EQTP = Equivalent temps plein  = 12 . moyenne du ratio rémunération / quotité*    \n#'    \n#'## `r chapitre`.1 Distribution de la rémunération nette moyenne sur la période    \n\nAnalyse.variations.par.exercice <- Analyse.variations.par.exercice[nb.jours > seuil.troncature\n                                                                   & ! is.na(Montant.net.annuel.eqtp)\n                                                                   & Montant.net.annuel.eqtp  > minimum.positif \n                                                                   & ! is.na(Statut)] \n\nattach(Analyse.variations.synthèse)\n\ntemp <- positive(moyenne.rémunération.annuelle.sur.période) / 1000\n\nif (longueur.non.na(temp) > 0)\n  hist(temp,\n       xlab = \"Sur la période \" %+% début.période.sous.revue %+% \"-\" %+% fin.période.sous.revue %+% \" en milliers d'euros\",\n       ylab = \"Effectif\",\n       main = \"Rémunération nette moyenne\",\n       col = \"blue\",\n       nclass = 200)\n\n#'\n#+ fig.height=4.5\n\ntemp <- na.omit(moyenne.rémunération.annuelle.sur.période[moyenne.rémunération.annuelle.sur.période > minimum.positif\n                                                          & (statut == \"TITULAIRE\"  | statut == \"STAGIAIRE\")] / 1000)\n\nif (longueur.non.na(temp) > 0)\n  hist(temp,\n       xlab = \"Sur la période \"%+% début.période.sous.revue %+% \"-\" %+% fin.période.sous.revue %+% \" en milliers d'euros\",\n       ylab = \"Effectif\",\n       main = \"Rémunération nette moyenne des fonctionnaires\",\n       col = \"blue\",\n       nclass = 200)\n\ndetach(Analyse.variations.synthèse)\n\n#'\n#'[Lien vers la base de données synthétique](Bases/Rémunérations/Analyse.variations.synthèse.csv)\n#'[Lien vers la base de données détaillée par année](Bases/Rémunérations/Analyse.variations.par.exercice.csv)\n#'\n#'## `r chapitre`.2 Evolutions des rémunérations nettes sur la période `r début.période.sous.revue` - `r fin.période.sous.revue`   \n#'\n#'### `r chapitre`.2.1 Ensemble des personnels fonctionnaires et non titulaires (hors élus)\n#'\n#'\n\n\nmasse.salariale.nette <- rep(0, durée.sous.revue)\n\nf <- function(x) prettyNum(masse.salariale.nette[x - début.période.sous.revue + 1] <<- \n                             sum(Analyse.variations.par.exercice[Année == x, \n                                                               Montant.net.annuel.eqtp],\n                               na.rm = TRUE) / 1000,\n                           big.mark = \" \",\n                           digits = 5,\n                           format = \"fg\")\n\ng <- function(x) prettyNum(mean.default(Analyse.variations.par.exercice[Année == x, \n                                                               Montant.net.annuel.eqtp],\n                               na.rm = TRUE),\n                           big.mark = \" \",\n                           digits = 1,\n                           format = \"fg\")\n#'    \n#'**Salaire net moyen par tête (SMPT net) en EQTP, hors élus**         \n#'       \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical(c(étiquette.année, \"Rém. nette totale (k&euro;)\", \"SMPT net (&euro;)\"),\n                 période,\n                 extra = \"variation\",\n                 f,\n                 g)\n\nentrants <- function(x)   {\n  \n  A <- setdiff(Analyse.variations.par.exercice[Année == x, Matricule], \n               Analyse.variations.par.exercice[Année == x -1, Matricule])\n  \n\n  B <- unique(Bulletins.paie[Année == x \n                             & Matricule %chin% A, \n                               .(Année, quotité, Matricule, Mois, Statut)], by = NULL)\n\n  eqtp.agent <- B[ , sum(quotité, na.rm=TRUE)] / 12\n  eqtp.fonct <- B[Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\", sum(quotité, na.rm=TRUE)] / 12\n\n  list(A, eqtp.agent, eqtp.fonct)\n}\n\nsortants <- function(x)   {\n  \n  A <- setdiff(Analyse.variations.par.exercice[Année == x-1, Matricule], \n               Analyse.variations.par.exercice[Année == x, Matricule])\n    \n  B <- unique(Bulletins.paie[Année == x - 1\n                             & Matricule %chin% A,\n                               .(Année, quotité, Matricule, Mois, Statut)], by = NULL)\n  \n  eqtp.agent <- B[ , sum(quotité, na.rm=TRUE)] / 12\n  eqtp.fonct <- B[Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\", sum(quotité, na.rm=TRUE)] / 12\n  \n  list(A, eqtp.agent, eqtp.fonct)\n}\n\ns <- list(0)\ne <- list(0)\nnoria <- rep(0, durée.sous.revue)\nremplacements <- rep(0, durée.sous.revue)\n\nf <- function(x) {\n  y <- x - début.période.sous.revue\n  \n  s[[y]] <<- sortants(x)\n  e[[y]] <<- entrants(x)\n  \n  noria[y] <<- mean.default(Analyse.variations.par.exercice[Année == x \n                                                            & Matricule %chin% e[[y]][[1]], \n                                                              Montant.net.annuel.eqtp],\n                    na.rm = TRUE) - mean.default(Analyse.variations.par.exercice[Année == x- 1 \n                                                                                 & Matricule %chin% s[[y]][[1]], \n                                                                                     Montant.net.annuel.eqtp],\n                                                 na.rm = TRUE)\n  \n  prettyNum(noria[y],\n            big.mark = \" \",\n            digits = 5,\n            format = \"fg\")\n}\n\ng <- function(x) {\n  \n  y <- x - début.période.sous.revue\n\n  remplacements[y] <<- min(e[[y]][[2]], s[[y]][[2]], na.rm=TRUE)\n  \n  prettyNum(noria[y] * remplacements[y] / (masse.salariale.nette[y] * 10),\n                           big.mark = \" \",\n                           digits = 3,\n                           format = \"fg\")\n}\n#'   \n#'**Effet de noria sur salaires nets et taux de remplacements**       \n#'   \n#'**Effet de noria** : *différence entre la rémunération annuelle des entrants à l'année N et des sortants à l'année N-1*.  \n#'*Usuellement calculée sur les rémunérations brutes, ici sur les rémunérations nettes EQTP*  \n#'*afin d'apprécier l'impact de cet effet sur l'évolution des rémunérations nette moyennes calculée au tableau précédent.*               \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \nif (durée.sous.revue > 1) {\nTableau.vertical(c(étiquette.année,  \"Noria EQTP (&euro;)\", \"En % de la MS N-1\", \"Remplacements EQTP\", \"Taux de remplacements (%)\"),\n                 période[2:durée.sous.revue],\n                 extra = \"no\",\n                 f,\n                 g,\n                 function(x) prettyNum(remplacements[x - début.période.sous.revue], \n                                       digits=0,\n                                       format=\"f\"),\n                 function(x) prettyNum(remplacements[x - début.période.sous.revue] / effectifs[[as.character(x)]][\"ETPT\"] * 100,\n                                       digits=2,\n                                       format=\"f\"))\n} else {\n  cat(\"L'effet de noria ne peut être calculé que pour des durées sous revue supérieures à un exercice.\")\n}\n\n#'\n#'*MS N-1 : masse salariale nette de l'année n-1.*   \n#'       \n#'**Distribution et variation sur la période du salaire moyen net par tête (SMPT net) en EQTP**         \n#'       \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(\"Première année\",\n       Analyse.variations.par.exercice[Année == début.période.sous.revue, Montant.net.annuel.eqtp])\n\nRésumé(\"Dernière année\",\n       Analyse.variations.par.exercice[Année == fin.période.sous.revue, Montant.net.annuel.eqtp])\n\n\n#'  \n#'*Nota :*  La population retenue est constituée des agents qui :   \n#'&nbsp;&nbsp;- ne font pas partie des `r 2*quantile.cut` centiles extrêmaux   \n#'&nbsp;&nbsp;- sont au moins présents `r seuil.troncature` jour(s) la première et la dernière année d'activité  \n#'Les élus, vacataires et assistantes maternelles sont retirés du périmètre.   \n#'Seuls sont pris en compte les agents ayant connu au moins un mois actif et ayant eu, sur l'année, des rémunérations non annexes.  \n#'[Compléments méthodologiques](Docs/méthodologie.pdf)     \n#'      \n#'**Comparaisons source INSEE/DGCL**   \n#'\n#'**Salaires annuels moyens 2011 et 2012 en EQTP (hors assistantes maternelles)**   \n#'  \n#'&nbsp;*Tableau `r incrément()`*       \n\n#### INSEE/DGCL DYN  ####\n  \nTableau.vertical2(c(\"Agrégat\",  \"Salaires nets 2011 (&euro;)\", \"Salaires nets 2012 (&euro;)\", \"Salaires nets 2013 (&euro;)\"),\n                  c(\"Ensemble\", \"Titulaires\", \"Autres salariés\"),\n                  12*c(1823, 1886, 1572),\n                  12*c(1848, 1910, NA),\n                  12*c(1852, 1910, NA))\n\n#'*Champ : France. Salariés en équivalent-temps plein (EQTP) des collectivités territoriales (y compris bénéficiaires de contrats aidés, hors assistantes maternelles).*     \t\t\t\n\n\nmatrice.déciles <- t(matrix(12*c(1458, 1274, 1382, 1170, 1743, 1376, 1514, 1305, 1921, 1459, 1635, 1428, 2076, 1540, 1754,\n                                 1559, 2236, 1636, 1883, 1712, 2412, 1751, 2042, 1902, 2636, 1905, 2268, 2156, 2966, 2133,\n                                 2583, 2569, 3538, 2573, 3151, 3400),  ncol = 9))\n\n\n#'**Distribution des salaires nets annuels en EQTP dans la fonction publique par versant en 2011**   \n#' \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n\nTableau.vertical2(c(\"Décile (k&euro;)\", \"FPE\", \"FPT\", \"FPH\", \"Secteur privé\"),\n                  paste0(\"D\", 1:9),\n                  matrice.déciles[,1],\n                  matrice.déciles[,2],\n                  matrice.déciles[,3],\n                  matrice.déciles[,4])\n\n\nmatrice.déciles.cat <- matrix(12*c(2170,2416,2606,2789,2985,3222,3523,3927,4570,1823,\n                                    1715,1856,1971,2080,2187,2303,2430,2582,2817,3225,\n                                    1331,1408,1471,1530,1597,1675,1768,1890,2083,2244,\n                                    1135,1195,1252,1307,1364,1436,1540,1732,2243,1668), nrow = 10)\n\n\n\n#'**Distribution des salaires nets annuels en EQTP dans la fonction publique territoriale par catégorie en 2011**   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical2(c(\"Décile (k&euro;)\", \"Catégorie A\", \"Catégorie B\", \"Catégorie C\", \"Autres salariés\"),\n                  c(paste0(\"D\", 1:9), \"Moyenne\"),\n                  matrice.déciles.cat[,1],\n                  matrice.déciles.cat[,2],\n                  matrice.déciles.cat[,3],\n                  matrice.déciles.cat[,4])\n\n#'[Source INSEE, onglets Figure3, F1web et F3web](http://www.insee.fr/fr/ffc/ipweb/ip1486/ip1486.xls)   \n#'   \n#'[Lien vers la base de données](Bases/Rémunérations/Analyse.variations.synthèse.csv)\n#'   \n\n#'### `r chapitre`.2.2 Fonctionnaires\n#'\n#'**Titulaires et stagiaires**      \n\nf <- function(x) {\n\n  masse.salariale.nette[x - début.période.sous.revue + 1] <<-  sum(Analyse.variations.par.exercice[Année == x\n                                                                                                   & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\"), \n                                                                                                      Montant.net.annuel.eqtp],\n                                                                na.rm = TRUE) / 1000\n\n prettyNum(masse.salariale.nette[x - début.période.sous.revue + 1],\n                           big.mark = \" \",\n                           digits = 5,\n                           format = \"fg\")\n}\n\ng <- function(x) prettyNum(mean.default(Analyse.variations.par.exercice[Année == x \n                                                                        & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\"), \n                                                                         Montant.net.annuel.eqtp],\n                           na.rm = TRUE),\n                   big.mark = \" \",\n                   digits = 1,\n                   format = \"fg\")\n\n\n#'**Salaire net moyen par tête (SMPT net) en EQTP**       \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical(c(étiquette.année, \"Rém. nette totale (k&euro;)\", \"SMPT net en EQTP (&euro;)\"),\n                 période,\n                 extra = \"variation\",\n                 f,\n                 g)\n\n#'\nf <- function(x) {\n  y <- x - début.période.sous.revue\n  \n  noria[y] <<- sum(Analyse.variations.par.exercice[Année == x \n                                                   & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\") \n                                                   & Matricule %chin% e[[y]][[1]], \n                                                     Montant.net.annuel.eqtp],\n                   na.rm = TRUE) / e[[y]][[3]] -  sum(Analyse.variations.par.exercice[Année == x- 1\n                                                                                      & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\") \n                                                                                      & Matricule %chin% s[[y]][[1]],\n                                                                                        Montant.net.annuel.eqtp],\n                                                  na.rm = TRUE) / s[[y]][[3]]\n  \n  prettyNum(noria[y],\n            big.mark = \" \",\n            digits = 5,\n            format = \"fg\")\n}\n\ng <- function(x) {\n  \n  y <- x - début.période.sous.revue\n\n  remplacements[y] <<- min(e[[y]][[3]], s[[y]][[3]], na.rm=TRUE)\n  \n  prettyNum(noria[y] * remplacements[y] / (masse.salariale.nette[y] * 10),\n            big.mark = \" \",\n            digits = 3,\n            format = \"fg\")\n}\n\n#'   \n#'**Effet de noria sur salaires nets et taux de remplacements**       \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nif (durée.sous.revue > 1) {\nTableau.vertical(c(étiquette.année,  \"Noria EQTP (&euro;)\", \"En % de la  MSN N-1\", \"Remplacements EQTP\", \"Taux de remplacements (%)\"),\n                 période[2:length(période)],\n                 extra = \"no\",\n                 f,\n                 g,\n                 function(x) prettyNum(remplacements[x - début.période.sous.revue], digits=0, format=\"f\"),\n                 function(x) prettyNum(remplacements[x - début.période.sous.revue]/ effectifs[[as.character(x)]][\"ETPT_fonct\"] * 100, digits=2, format=\"f\"))\n} else {\n  cat(\"L'effet de noria ne peut être calculé que pour des durées sous revue supérieures à un exercice.\")\n}\n#'     \n#'*MS N-1 : masse salariale nette de l'année n-1.*   \n#'       \n#'**Distribution et variation sur la période du salaire moyen net par tête (SMPT net) en EQTP**         \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n\nRésumé(\"Première année\",\n       Analyse.variations.par.exercice[Année == début.période.sous.revue\n                                       & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\"),\n                                           Montant.net.annuel.eqtp])\n\nRésumé(\"Dernière année\",\n       Analyse.variations.par.exercice[Année == fin.période.sous.revue \n                                       & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\"),\n                                         Montant.net.annuel.eqtp])\n\n\n#'    \nf <- function(x) prettyNum(sum(Analyse.variations.par.exercice[Année == x \n                                                               & Statut == \"TITULAIRE\"\n                                                               & temps.complet == TRUE & permanent == TRUE, \n                                                                 Montant.net.annuel.eqtp],\n                               na.rm = TRUE) / 1000,\n                           big.mark = \" \",\n                           digits = 5,\n                           format = \"fg\")\n\ng <- function(x) prettyNum(mean.default(Analyse.variations.par.exercice[Année == x\n                                                               & Statut == \"TITULAIRE\"\n                                                               & temps.complet == TRUE & permanent == TRUE, \n                                                                 Montant.net.annuel.eqtp],\n                                        na.rm = TRUE),\n                           big.mark = \" \",\n                           digits = 1,\n                           format = \"fg\")\n\n#'   \n#'**Evolution du SMPT net des titulaires à temps complet**     \n#'   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical(c(étiquette.année, \"Rémunération nette totale (k&euro;)\", \"SMPT (&euro;)\"),\n                 période,\n                 extra = \"variation\",\n                 f,\n                 g)\n\n#'    \n#'**Distribution et variation sur la période du salaire moyen net par tête (SMPT net) des titulaires à temps complet**         \n#'       \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n\nRésumé(\"Première année\",\n       Analyse.variations.par.exercice[Année == début.période.sous.revue\n                                       & Statut == \"TITULAIRE\" \n                                       & temps.complet == TRUE\n                                       & permanent == TRUE,\n                                           Montant.net.annuel.eqtp])\n\n#'   \nRésumé(\"Dernière année\",\n       Analyse.variations.par.exercice[Année == fin.période.sous.revue\n                                       & Statut == \"TITULAIRE\" \n                                       & temps.complet == TRUE\n                                       & permanent == TRUE,\n                                         Montant.net.annuel.eqtp])\n\n\n#'\n#'[Lien vers la base de données](Bases/Rémunérations/Analyse.variations.synthèse.csv)\n#'\n#'\n\n#'## `r chapitre`.3 Glissement vieillesse-technicité (GVT)   \n#'\n#'### `r chapitre`.3.1 Ensemble des personnels   \n#'   \n#'*Cette section est consacrée à la rémunération moyenne des personnes en place (RMPP), définies comme présentes deux années entières consécutives avec la même quotité*   \n#'*L'évolution de la RMPP permet d'étudier le glissement vieillesse-technicité \"positif\", à effectifs constants sur deux années*      \n#'*Le GVT positif est dû aux mesures statutaires et individuelles, à l'avancement et aux changements d'activité*  \n\n\n# Appliquer les filtres maintenant\n\nq3 <- quantile(Analyse.variations.synthèse$variation.rémunération, c(quantile.cut/100, 1 - quantile.cut/100), na.rm=TRUE)\n\n# Filtrage : on enlève les personnels présents depuis moins d'un seuil de troncature (ex. 120 jours) dans l'année et les élus\n# (paramètre seuil.troncature) \n\n# Filtrage pour l'étude des variations : on enlève les valeurs manquantes des variations, les centiles extrêmaux,\n# les rémunérations nettes négatives ou proche de zéro. On exige un statut explicite en fin de période.\n# Paramétrable par :\n# minimum.positif, quantile.cut \n\n\nAnalyse.variations.synthèse <- Analyse.variations.synthèse[total.jours > 2 * seuil.troncature\n                                                           & pris.en.compte == TRUE\n                                                           & ! is.na(statut)   \n                                                           & ! is.na(variation.rémunération) \n                                                           & variation.rémunération > q3[[1]]\n                                                           & variation.rémunération < q3[[2]]]\n\nAnalyse.variations.synthèse.plus.2.ans  <- Analyse.variations.synthèse[! is.na(plus.2.ans) & plus.2.ans == TRUE]\nAnalyse.variations.synthèse.moins.2.ans <- Analyse.variations.synthèse[! is.na(plus.2.ans) & plus.2.ans == FALSE]\n\n#Analyse.variations.par.exercice <- Analyse.variations.par.exercice[Nexercices > 1]\n\n\nif (nrow(Analyse.variations.synthèse.plus.2.ans) > 0)\n  hist(Analyse.variations.synthèse.plus.2.ans$variation.moyenne.rémunération,\n       xlab =\"Variation annuelle moyenne en %\",\n       las = 1,\n       xlim = c(-5,30),\n       ylab =\"Effectifs\",\n       main =\"Rémunération nette des personnes en place\",\n       col =\"blue\",\n       nclass=1000,\n       xaxt = 'n')\n\ntry(axis(side=1, at=seq(-5,30, 1), labels=seq(-5,30,1), lwd=2))\n\n#'\n#'\n\nf <- function(x) prettyNum(sum(Analyse.variations.par.exercice[Année == x\n                                                               & est.rmpp == TRUE,\n                                                                 Montant.net.annuel.eqtp],\n                               na.rm = TRUE)/ 1000,\n                           big.mark = \" \",\n                           digits = 5,\n                           format = \"fg\")\n\ng <- function(x) prettyNum(mean.default(Analyse.variations.par.exercice[Année == x \n                                                                        & est.rmpp == TRUE,\n                                                                          Montant.net.annuel.eqtp],\n                               na.rm = TRUE) ,\n                           big.mark = \" \",\n                           digits = 1,\n                           format = \"fg\")\n#'   \n#'**Evolution de la RMPP nette en EQTP**     \n#'   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical(c(étiquette.année,\n                   \"Rémunération nette totale (k&euro;)\",\n                   \"RMPP nette (k&euro;)\"),\n                 période[2:durée.sous.revue],\n                 extra = \"variation\",\n                 f,\n                 g)\n\n\n#'    \n#'**Distribution et variation sur la période de la rémunération nette des personnes en place**                \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n# La légère différence de pérmètre entre Analyse.variations.synthèse et Analyse.variations.par.exercice tient au filtrage des quantiles\n# extrêmaux et des valeurs manquantes des variations\n\n\nmasque.rmpp.fin.période    <- bitwShiftL(3, durée.sous.revue - 2)      #  11{0,1}...{0,1}\nmasque.rmpp.début.période  <- 3                                        #  {0,1}...{0,1}11\nmasque.présent.début.fin   <- bitwShiftL(1, durée.sous.revue - 1) + 1  #  10000..1\nmasque.présent.sur.période <- bitwShiftL(1, durée.sous.revue) -1       #  11111..1\n\n#'  \nRésumé(c(\"Première année\",\n         \"Effectif\"),\n       Analyse.variations.synthèse[bitwAnd(indicatrice.période, masque.rmpp.début.période) == masque.rmpp.début.période, \n                                           Montant.net.annuel.eqtp.début],\n       extra = \"length\")\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Dernière année\",\n         \"Effectif\"),\n        Analyse.variations.synthèse[indicatrice.période >= masque.rmpp.fin.période, Montant.net.annuel.eqtp.sortie],\n        extra = \"length\")\n#'\n#'*Variation individuelle de rémunération nette en EQTP pour les personnels présents la première et la dernière année*   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Variation normalisée (%)\",\n         \"Variation annuelle moyenne normalisée (%)\",\n         \"Effectif\"),\n         Analyse.variations.synthèse[bitwAnd(indicatrice.période, masque.présent.début.fin) \n                                        == \n                                     masque.présent.début.fin,\n                                       .(variation.rémunération.normalisée,\n                                         variation.moyenne.rémunération.normalisée)],\n       extra = \"length\")\n\n# #'\n# #'*Variation individuelle de rémunération nette en EQTP pour les personnels présents sur toute la période*   \n# #'  \n# #'&nbsp;*Tableau `r incrément()`*   \n# #'  \n# \n# Résumé(\"Variation normalisée (%)\",\n#         # \"Variation annuelle moyenne normalisée (%)\",\n#          \"Effectif\"),\n#        Analyse.variations.synthèse[indicatrice.période == masque.présent.sur.période, variation.rémunération.normalisée],\n#        extra = \"length\")\n\n#'    \n#'### `r chapitre`.3.2 Titulaires et stagiaires     \n#'   \n\nf <- function(x) prettyNum(sum(Analyse.variations.par.exercice[Année == x\n                                                               & est.rmpp == TRUE\n                                                               & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\"),\n                                                                 Montant.net.annuel.eqtp],\n                               na.rm = TRUE)/ 1000,\n                           big.mark = \" \",\n                           digits = 5,\n                           format = \"fg\")\n\ng <- function(x) prettyNum(mean.default(Analyse.variations.par.exercice[Année == x \n                                                                        & est.rmpp == TRUE\n                                                                        & (Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\"),\n                                                                          Montant.net.annuel.eqtp],\n                                        na.rm = TRUE) ,\n                           big.mark = \" \",\n                           digits = 1,\n                           format = \"fg\")\n#'   \n#'**Evolution de la RMPP nette en EQTP**     \n#'   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n\nTableau.vertical(c(étiquette.année,\n                   \"Rémunération nette totale (k&euro;)\",\n                   \"RMPP nette (k&euro;)\"),\n                 période[2:durée.sous.revue],\n                 extra = \"variation\",\n                 f,\n                 g)\n\n#'    \n#'**Distribution et variation sur la période de la rémunération nette des fonctionnaires en place**                \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\n#'  \nRésumé(c(\"Première année\",\n         \"Effectif\"),\n       Analyse.variations.synthèse[(statut == \"TITULAIRE\" | statut == \"STAGIAIRE\")\n                                   & bitwAnd(indicatrice.période, masque.rmpp.début.période) == masque.rmpp.début.période, \n                                     Montant.net.annuel.eqtp.début],\n       extra = \"length\")\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Dernière année\",\n         \"Effectif\"),\n       Analyse.variations.synthèse[statut == \"TITULAIRE\" | statut == \"STAGIAIRE\"\n                                   & indicatrice.période >= masque.rmpp.fin.période, \n                                     Montant.net.annuel.eqtp.sortie],\n       extra = \"length\")\n#'\n#'*Variation individuelle de rémunération nette en EQTP pour les personnels présents la première et la dernière année*   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nRésumé(c(\"Variation normalisée (%)\",\n         \"Variation annuelle moyenne normalisée (%)\",\n         \"Effectif\"),\n       Analyse.variations.synthèse[(statut == \"TITULAIRE\" | statut == \"STAGIAIRE\")\n                                   & bitwAnd(indicatrice.période, masque.présent.début.fin)\n                                      ==\n                                     masque.présent.début.fin,\n                                     .(variation.rémunération.normalisée,  variation.moyenne.rémunération.normalisée)],\n       extra = \"length\")\n\n\n#'\n#'\n#'[Lien vers la base de données](Bases/Rémunérations/Analyse.variations.synthèse.csv)\n#'\n#'**Nota**   \n#'*Personnes en place :* en fonction au moins deux années consécutives sur la période `r début.période.sous.revue` à `r fin.période.sous.revue`    \n#'*Variation sur la période d'activité :* entre l'arrivée et le départ de la personne      \n#'*Variation normalisée :* conforme à la définition INSEE (présente en début et en fin de période avec la même quotité)  \n#'  \n#'**Commentaire**       \n#'Les différences éventuelles constatées entre l'évolution de la RMPP au tableau `r numéro.tableau-2` sont dues soit à l'effet de noria soit à l'effet périmètre.    \n#'      \n\n#'[Lien vers la base de données](Bases/Rémunérations/Analyse.variations.synthèse.csv)\n#'\n#'\n#'### `r chapitre`.4 Comparaisons avec la situation nationale des rémunérations   \n#'  \n#'**Évolution en euros courants du SMPT et de la RMPP dans la FPT (en % et euros courants)**    \n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical2(c(\"Année\", \"2008-09\", \"2009-10\", \"2010-11\", \"2011-12\", \"2012-13\", \"2008-12\", \"Moy. 2008-12\", \"Méd. 2007-11\"),\n                  c(\"SMPT brut\", \"SMPT net\", \"RMPP brute\", \"RMPP nette\"),         \n                  t(data.frame(c(\"2,5\", \"1,3\", \"1,5\", \"1,7\", \"1,1\", \"7,2\", \"1,8\", \"\"),\n                  c(\"3,0\", \"1,4\", \"1,3\", \"1,4\", \"0,8\", \"7,3\", \"1,8\", \"13,4\"),\n                  c(\"3,3\", \"2,5\", \"2,5\", \"2,7\", \"1,9\", \"11,5\", \"2,8\", \"\"),\n                  c(\"3,3\", \"2,5\", \"2,3\", \"2,4\", \"1,6\", \"10,9\", \"2,6\", \"\"))))\n\n\n#'*Source : fichier général de l'État (FGE), DADS, SIASP, Insee, Drees. Traitement Insee, Drees, DGCL*    \n#'Hors assistants maternels et familiaux, y compris bénéficiaires de contrats aidés.   \n#'SMPT : Salaire moyen par tête en EQTP.   \n#'RMPP : Agents présents 24 mois consécutifs chez le même employeur avec la même quotité de travail.  \n#'Moyenne des variations géométriques annuelles pour les agents du champ.  \n#'La dernière colonne présente la médiane des augmentations du SMPT net pour les agents présents en 2007 et 2011.   \n#'  \n#'**Salaires nets annuels et évolution moyenne type de collectivité en &euro; courants  EQTP**    \n#'   \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau.vertical2(c(\"Collectivité\", \"SMPT net 2011\", \"SMPT net 2012\", \"SMPT net 2013\",  \"Evol. Moy. 2007-2011 (%)\"),\n  c(\"Communes\",\n    \"CCAS et caisses des écoles\",\n    \"EPCI à fiscalité propre\",\n    \"Autres structures intercommunales\",\n    \"Départements\",\n    \"SDIS\",\n    \"Régions\",\t\t \n    \"Autres collectivités locales\",\t \n    \"Ensemble (moyenne)\"),\t\n   c(20784, 19415, 22882, 21299, 24487, 29811, 22432, 24680, 21873),\n  12*c(1760, 1643, 1924, 1807, 2062, 2495, 1903,  2058, 1848),\n  12*c(1758, 1649, 1932, 1819, 2071, 2515, 1917,  2069, 1851),\n   c(\"2,5\", \"2,4\", \"3,1\", \"3,0\", \"3,9\", \"3,4\", \"3,8\", \"3,2\", \"2,9\"))\n\n#'\n#'*Champ : France. Salariés en équivalent-temps plein (EQTP) des collectivités territoriales (y compris bénéficiaires de contrats aidés, hors assistantes maternelles).*     \t\t\t\n#'Conversion en euros courants, calcul CRC.  \n#'[Source INSEE données 2011 obsolètes](http://www.insee.fr/fr/ffc/ipweb/ip1486/ip1486.xls)   \n#'[Source DGAFP](http://infos.emploipublic.fr/dossiers/la-fonction-publique-en-chiffres/la-fonction-publique-en-chiffre-2013/non-defini-08/apm-71444/)  \n#'[Source PLF 2014 données 2011 révisées p.151](http://www.fonction-publique.gouv.fr/files/files/statistiques/jaunes/jaune2014_FP.pdf)   \n#'[Source PLF 2015 données 2012 p.130](http://www.performance-publique.budget.gouv.fr/sites/performance_publique/files/farandole/ressources/2015/pap/pdf/jaunes/jaune2015_fonction_publique.pdf)   \n#'    \n\nincrémenter.chapitre()\n\n#'\n########### TESTS STATUTAIRES ########################\n#'\n\n#### NBI ####\n\n#'# `r chapitre`. Tests réglementaires   \n#'## `r chapitre`.1 Contrôle des heures supplémentaires, des NBI et primes informatiques   \n#'   \n#'**Dans cette partie, l'ensemble de la base de paie est étudié.**  \n#'Les agents non actifs ou dont le poste est annexe sont réintroduits dans le périmètre.   \n\nif (N <- uniqueN(Paie[Statut != \"TITULAIRE\"\n                            & Statut != \"STAGIAIRE\"\n                            & NBI != 0, \n                              Matricule]))\n  cat(\"Il existe \", FR(N), \"non titulaire\", ifelse(N>1, \"s\", \"\"), \" percevant une NBI.\")\n\nNBI.aux.non.titulaires <- Paie[Statut != \"TITULAIRE\"\n                               & Statut != \"STAGIAIRE\"\n                               & NBI != 0\n                               & grepl(expression.rég.nbi, Libellé, ignore.case=TRUE, perl=TRUE),\n                                 c(étiquette.matricule,\n                                   \"Statut\",\n                                   étiquette.code,\n                                   étiquette.libellé,\n                                   étiquette.année,\n                                   \"Mois\",\n                                   \"NBI\",\n                                   étiquette.montant),\n                                 with=FALSE]\n\nnombre.Lignes.paie.NBI.nontit <- nrow(NBI.aux.non.titulaires)\n\n# Prime de fonctions informatiques : pas dans la base de VLB\n# on cherche la chaine de char. \"INFO\" dans les libellés de primes\n\n# variante : filtre <- regexpr(\".*(INFO|PFI|P.F.I).*\", toupper(Paie$Libellé)) et regmatches(Paie$Libellé, filtre)\n\nattach(Paie, warn.conflicts=FALSE)\nfiltre <- grep(expression.rég.pfi, Libellé, ignore.case=TRUE, perl=TRUE)\n\npersonnels.prime.informatique <- Paie[ filtre,\n                                         c(étiquette.matricule,\n                                           étiquette.année,\n                                           \"Mois\",\n                                           \"Statut\",\n                                           étiquette.code,\n                                           étiquette.libellé,\n                                           étiquette.montant),\n                                           with=FALSE]\n\nprimes.informatiques.potentielles <- unique(Libellé[filtre], by=NULL)\n\nif  (length(primes.informatiques.potentielles) == 0)\n  primes.informatiques.potentielles <- \"aucune\"\n\nnombre.personnels.pfi <- nrow(personnels.prime.informatique)\n\ndetach(Paie)\n#'Primes informatiques potentielles : `r primes.informatiques.potentielles`\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau(\n  c(\"Nombre de lignes NBI pour non titulaires\",\n    \"Nombre de bénéficiaires de PFI\"),\n  nombre.Lignes.paie.NBI.nontit,\n  nombre.personnels.pfi)\n\n#'   \n#'[Lien vers la base de données NBI aux non titulaires](Bases/Réglementation/NBI.aux.non.titulaires.csv)   \n#'[Lien vers la base de données Primes informatiques](Bases/Réglementation/personnels.prime.informatique.csv)   \n#'   \n#'**Nota :**   \n#'NBI: nouvelle bonification indiciaire   \n#'PFI: prime de fonctions informatiques   \n#'\n\nT1 <- Bulletins.paie[ , .(nbi.cumul.indiciaire=sum(NBI, na.rm = TRUE)), by=\"Matricule,Année\"] \nT1 <- T1[nbi.cumul.indiciaire > 0] \n\nT2 <- Paie[grepl(expression.rég.nbi, Libellé, perl=TRUE, ignore.case=TRUE) == TRUE \n           & Type %chin% c(\"T\", \"I\")\n           & NBI != 0,\n           .(nbi.cumul.montants = sum(Montant, na.rm=TRUE)), keyby=\"Matricule,Année\"]\n\nT2 <- T2[nbi.cumul.montants != 0]\n\nT <- merge(T1, T2, by=c(\"Matricule\", \"Année\"))\n\ncumuls.nbi <- T[, .(cumul.annuel.indiciaire = sum(nbi.cumul.indiciaire, na.rm = TRUE),\n      cumul.annuel.montants = sum(nbi.cumul.montants, na.rm = TRUE)), keyby=\"Année\"]\n\nT <- T[, ratio := nbi.cumul.montants/nbi.cumul.indiciaire]\n\nT <- T[, nbi.anormale := (abs(ratio) < 4 | abs(ratio) > 6)]\n\nlignes.nbi.anormales <- T[nbi.anormale == TRUE, .(Matricule, Année, nbi.cumul.indiciaire, nbi.cumul.montants)]\n\nmontants.nbi.anormales <- sum(lignes.nbi.anormales$nbi.cumul.montants, na.rm = TRUE)\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau(\n  c(\"Rémunérations de NBI anormales, par agent et par exercice\",\n    \"Montants correspondants\"),\n  nrow(lignes.nbi.anormales),\n  formatC(montants.nbi.anormales, big.mark = \" \", format=\"f\", digits=0))\n\nrm(T, T1, T2)\n#'   \n#'[Lien vers la base de données NBI anormales](Bases/Fiabilité/lignes.nbi.anormales.csv)   \n#'   \n#'**Nota :**   \n#'*Est considéré comme manifestement anormal un total annuel de rémunérations NBI correspondant à un point d'indice net mensuel inférieur à 4 euros ou supérieur à 6 euros.*    \n#'*Les rappels ne sont pas pris en compte dans les montants versés. Certains écarts peuvent être régularisés en les prenant en compte*     \n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \nattach(cumuls.nbi)\n\nTableau.vertical2(c(\"Année\", \"Cumuls des NBI\", \"Montants versés (a)\", \"Point d'INM apparent\", \"Point d'INM moyen\", \"Contrôle\"), \n                  Année, \n                  cumul.annuel.indiciaire,\n                  cumul.annuel.montants,\n                  a <- cumul.annuel.montants/cumul.annuel.indiciaire,\n                  b <- PointMensuelIMMoyen[Année - 2007],\n                  ifelse(abs(b - a) > 0.3, \"Rouge\", ifelse(abs(b - a) > 0.15, \"Orange\", \"Vert\")))\n#'\n#'*(a) Hors rappels sur rémunérations*   \n#'\n\ndetach(cumuls.nbi)\n\n#### VACATIONS ####\n#'   \n#'[Lien vers la base de données des cumuls annuels de NBI](Bases/Fiabilité/cumuls.nbi.csv)   \n#'   \n\n#'  \n#'## `r chapitre`.2 Contrôle des vacations pour les fonctionnaires\n\n# Vacations et statut de fonctionnaire\n\n  lignes.fonctionnaires.et.vacations <- Paie[(Statut == \"TITULAIRE\" | Statut == \"STAGIAIRE\") & Grade == \"V\",\n                                                c(étiquette.matricule,\n                                                  \"Nom\", \"Prénom\",\n                                                  \"Statut\",\n                                                  étiquette.code,\n                                                  étiquette.libellé,\n                                                  étiquette.montant),\n                                                 with=FALSE]\n   \n  matricules.fonctionnaires.et.vacations <- unique(lignes.fonctionnaires.et.vacations[ , .(Matricule, Nom, Prénom)], by=NULL)\n  nombre.fonctionnaires.et.vacations <- nrow(matricules.fonctionnaires.et.vacations)\n#'\n\nif (! is.null(nombre.fonctionnaires.et.vacations)) {\n  cat(\"Il y a \",\n      FR(nombre.fonctionnaires.et.vacations),\n      \"fonctionnaire(s) effectuant des vacations pour son propre établissement. Les bulletins concernés sont donnés en lien.\" )\n}  else  {\n  cat(\"Pas de vacation détectée.\")\n}\n\n\n#'\n#'[Lien vers les matricules des fonctionnaires concernés](Bases/Réglementation/matricules.fonctionnaires.et.vacations.csv)\n#'[Lien vers les bulletins de paie correspondants](Bases/Réglementation/lignes.fonctionnaires.et.vacations.csv)\n#'\n#'## `r chapitre`.3 Contrôles sur les cumuls traitement indiciaire, indemnités et vacations des contractuels    \n\n# Vacations et régime indemnitaire\n\n  lignes.contractuels.et.vacations <- Paie[Statut != \"TITULAIRE\"\n                                           & Statut != \"STAGIAIRE\"\n                                           & Grade == \"V\",\n                                             c(étiquette.matricule,\n                                               \"Nom\", \n                                               \"Prénom\",\n                                               étiquette.code,\n                                               étiquette.libellé,\n                                               étiquette.montant),\n                                             with=FALSE]\n\n  matricules.contractuels.et.vacations <- unique(lignes.contractuels.et.vacations[ , .(Matricule, Nom, Prénom)], by=NULL)\n\n  nombre.contractuels.et.vacations     <- nrow(matricules.contractuels.et.vacations)\n    \n  RI.et.vacations         <- data.frame(NULL)\n  traitement.et.vacations <- data.frame(NULL)\n\n if (nombre.contractuels.et.vacations) \n  {\n     RI.et.vacations <- Paie[Type == \"I\"\n                             & Matricule %chin% matricules.contractuels.et.vacations$Matricule,\n                               c(étiquette.matricule,\n                                 \"Statut\",\n                                 étiquette.code,\n                                 \"Type\",\n                                 étiquette.libellé,\n                                 étiquette.montant), \n                               with=FALSE]\n  \n  # Vacations et indiciaire\n  \n    traitement.et.vacations <- Paie[Type == \"T\" \n                                    & Matricule %chin% matricules.contractuels.et.vacations$Matricule,\n                                      c(étiquette.matricule,\n                                        \"Statut\",\n                                        étiquette.code,\n                                        \"Type\",\n                                        étiquette.libellé,\n                                        étiquette.montant),\n                                      with=FALSE]\n  }\n\n  nombre.Lignes.paie.contractuels.et.vacations <- nrow(lignes.contractuels.et.vacations)\n  nombre.Lignes.paie.RI.et.vacations           <- nrow(RI.et.vacations)\n  nombre.Lignes.paie.traitement.et.vacations   <- nrow(traitement.et.vacations)\n\n#'\n#'**Contractuels effectuant des vacations (CEV)**\n#'\n\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n  \nif (exists(\"nombre.contractuels.et.vacations\")) {\n  \n  Tableau(c(\"Nombre de CEV\",\n            \"Nombre de lignes\",\n            \"Nombre de lignes indemnitaires\",\n            \"Nombre de lignes de traitement\"),\n            nombre.contractuels.et.vacations,\n            nombre.Lignes.paie.contractuels.et.vacations,\n            nombre.Lignes.paie.RI.et.vacations,\n            nombre.Lignes.paie.traitement.et.vacations)\n}\n  \n#'  \n#'[Lien vers le bulletins des CEV](Bases/Réglementation/lignes.contractuels.et.vacations.csv)   \n#'[Lien vers la base de données Matricules des CEV](Bases/Réglementation/matricules.contractuels.et.vacations.csv)  \n#'[Lien vers la base de données Cumul régime indemnitaire et vacations de CEV](Bases/Réglementation/RI.et.vacations.csv)  \n#'[Lien vers la base de données Lignes de traitement indiciaire pour CEV](Bases/Réglementation/traitement.et.vacations.csv)  \n#'  \n\n#### IAT/IFTS ####  \n  \n#'\n#'## `r chapitre`.4 Contrôle sur les indemnités IAT et IFTS      \n\n#IAT et IFTS\n\nrésultat.ifts.manquant <- FALSE\nrésultat.iat.manquant  <- FALSE\n\nPaie <- Paie[ , `:=`(ifts.logical = grepl(expression.rég.ifts, Paie$Libellé, ignore.case=TRUE, perl=TRUE),\n                     iat.logical  = grepl(expression.rég.iat, Paie$Libellé, ignore.case=TRUE, perl=TRUE))]\n\n\ncodes.ifts  <- list(\"codes IFTS\" = unique(Paie[ifts.logical == TRUE][ , Code]))\n\nif (length(codes.ifts) == 0) {\n  cat(\"Il n'a pas été possible d'identifier les IFTS par expression régulière.\")\n  résultat.ifts.manquant <- TRUE\n}\n\nif (! any(Paie$iat.logical)) {\n  cat(\"Il n'a pas été possible d'identifier les IAT par expression régulière.\")\n  résultat.iat.manquant <- TRUE\n}\n\nnombre.agents.cumulant.iat.ifts <- 0\n\nif (! résultat.ifts.manquant && ! résultat.iat.manquant) {\n  \n  Paie[ , cumul.iat.ifts := any(ifts.logical[Type == \"I\"]) & any(iat.logical[Type == \"I\"]), by=\"Matricule,Année,Mois\"]\n  \n  # on exclut les rappels !\n  \n  personnels.iat.ifts <- Paie[cumul.iat.ifts == TRUE\n                              & (ifts.logical == TRUE | iat.logical == TRUE),\n                                .(Matricule, Année, Mois, Code, Libellé, Montant, Type, Emploi, Grade, Service)]\n  \n  nombre.mois.cumuls <- uniqueN(personnels.iat.ifts[ , .(Matricule, Année, Mois)], \n                                    by = NULL)\n  \n  nombre.agents.cumulant.iat.ifts <- uniqueN(personnels.iat.ifts$Matricule)\n  \n  personnels.iat.ifts <- personnels.iat.ifts[order(Année, Mois, Matricule)]\n}\n\n#'\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'      \nif (nombre.agents.cumulant.iat.ifts) {\n  if (length(codes.ifts) < 10) {\n    Tableau(c(\"Codes IFTS\", \" \"),\n            sep.milliers = \"\",\n            paste(unlist(codes.ifts), collapse=\" \"), \" \")\n  } else {\n    \n    cat (\"Nombre de personnels percevant IAT et IFTS : \", paste(unlist(codes.ifts), collapse=\" \"), \"\\n\")\n  }\n}\n\n# Pour de mystérieuses raisons liées à Tableau() il faut répéter la condition.\n\nif (nombre.agents.cumulant.iat.ifts) {\n  \n  Tableau(c(\"Nombre de personnels percevant IAT et IFTS\", \" \"), nombre.agents.cumulant.iat.ifts, \" \")\n       \n} else {\n  cat(\"Tests IAT/IFTS sans résultat positif.\")\n}\n\n#'   \n#'[Codes IFTS retenus](Bases/Réglementation/codes.ifts.csv)   \n#'[Lien vers la base de données cumuls iat/ifts](Bases/Réglementation/personnels.iat.ifts.csv)    \n#'\n#'### Contrôle sur les IFTS pour catégories B et contractuels\n\n#IFTS et IB >= 380 (IM >= 350)\n#'  \nif (! résultat.ifts.manquant) {\n    lignes.ifts.anormales <- na.omit(Paie[as.integer(Indice) < 350   \n                                          & ifts.logical == TRUE,\n                                            c(clé.fusion,\n                                              étiquette.année,\n                                              \"Mois\",\n                                              \"Statut\",\n                                              étiquette.code,\n                                              étiquette.libellé,\n                                              \"Indice\",\n                                              étiquette.montant,\n                                              \"Service\"), \n                                            with=FALSE])\n} else {\n\n    lignes.ifts.anormales <- NULL\n    cat(\"Il n'a pas été possible de déterminer les lignes IFTS anormales faute d'indentification des libellés IFTS.\")\n}\n#'  \nnombre.lignes.ifts.anormales <- nrow(lignes.ifts.anormales)\n\n# IFTS et non tit\n\nifts.et.contractuel <- NULL \n\nif (! résultat.ifts.manquant) {\n  \n  ifts.et.contractuel <- Paie[ Statut != \"TITULAIRE\"\n                              & Statut != \"STAGIAIRE\"\n                              & ifts.logical == TRUE,\n                               c(étiquette.matricule,\n                                 étiquette.année,\n                                 \"Mois\",\n                                 \"Statut\",\n                                 étiquette.code,\n                                 étiquette.libellé,\n                                 \"Indice\",\n                                 étiquette.montant),\n                               with=FALSE]\n  }\n\nnombre.lignes.ifts.et.contractuel <- nrow(ifts.et.contractuel)\n\n#'\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nif (! résultat.ifts.manquant) {\n   Tableau(c(\"Nombre de lignes de paie de contractuels percevant des IFTS\", \"Nombre de lignes IFTS pour IB < 380\"), nombre.lignes.ifts.et.contractuel, nombre.lignes.ifts.anormales)\n}\n\n#'\n#'[Lien vers la base de données Lignes IFTS pour contractuels](Bases/Réglementation/ifts.et.contractuel.csv)    \n#'[Lien vers la base de données Lignes IFTS pour IB < 380](Bases/Réglementation/lignes.ifts.anormales.csv)     \n#'\n#'**Nota :**\n#'IB < 380 : fonctionnaire percevant un indice brut inférieur à 380\n#'\n\n#### PFR ####\n\n#'\n#'## `r chapitre`.5 Contrôle de la prime de fonctions et de résultats (PFR)   \n#'   \nrésultat.pfr.manquant <- FALSE\nnombre.agents.cumulant.pfr.ifts <- 0\n\n# L'expression régulière capte la PFR et la PR \n# Le cumul de la PR et de l'IFTS est régulier, de même que celui de la PR et de la PFR\n# le cumul de la PFR et de l'IFTS est irrrégulier\n\nPaie[ , pfr.logical := grepl(expression.rég.pfr, Paie$Libellé, ignore.case=TRUE, perl=TRUE)]\n\ncodes.pfr  <- list(\"codes PFR\" = unique(Paie[pfr.logical == TRUE, Code]))\n\nif (length(codes.pfr) == 0) {\n  cat(\"Il n'a pas été possible d'identifier la PFR par expression régulière.\")\n  résultat.pfr.manquant <- TRUE\n}\n\nif (! résultat.ifts.manquant && ! résultat.pfr.manquant) {\n  \n  Paie[ , cumul.pfr.ifts := (any(pfr.logical[Type == \"I\"]) \n                               & any(ifts.logical[Type == \"I\"])), \n         by=\"Matricule,Année,Mois\"]\n\n  # on exclut les rappels !\n  \n  personnels.pfr.ifts <- Paie[cumul.pfr.ifts == TRUE \n                              & Type == \"I\"\n                              & (pfr.logical == TRUE | ifts.logical == TRUE),\n                              .(Matricule, Année, Mois, Code, Libellé, Montant, Type, Emploi, Grade, Service)]\n  \n  nombre.mois.cumuls <- uniqueN(personnels.pfr.ifts[ , .(Matricule, Année, Mois)], by = NULL)\n  \n  nombre.agents.cumulant.pfr.ifts <- uniqueN(personnels.pfr.ifts$Matricule)\n  \n  personnels.pfr.ifts <- personnels.pfr.ifts[order(Année, Mois, Matricule)]\n}\n\n#'\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'      \nif (length(codes.pfr) < 6) {\n  Tableau(c(\"Codes PFR\", \"Agents cumulant PFR et IFTS\"),\n          sep.milliers = \"\",\n          paste(unlist(codes.pfr), collapse = \" \"),\n          nombre.agents.cumulant.pfr.ifts)\n} else {\n  \n  cat(\"Codes PFR : \", paste(unlist(codes.pfr), collapse = \" \"), \"\\n\")\n  \n}\n\nif (length(codes.pfr) > 5) {\n  Tableau(\"Agents cumulant PFR et IFTS\",\n          nombre.agents.cumulant.pfr.ifts)\n}\n\n#'   \n#'[Lien vers la base de données cumuls pfr/ifts](Bases/Réglementation/personnels.pfr.ifts.csv)    \n#'\n\n  P <- Paie[Code %chin% union(unlist(codes.pfr), unlist(codes.ifts)),\n            .(Attrib.PFR = any(pfr.logical), Cumul.PFR.IFTS = sum(Montant, na.rm = TRUE), Grade = Grade[1]), \n            by=\"Nom,Matricule,Année\"]\n  \n  P.any <- P[, .(attrib.any = any(Attrib.PFR)), by=\"Nom,Matricule\"]\n  \n  P <- merge(P, P.any, by=c(\"Nom\", \"Matricule\"))\n  P <- P[attrib.any == TRUE]\n  \n  bénéficiaires.PFR <- P[, attrib.any := NULL]\n  bénéficiaires.PFR <- P[, Attrib.PFR := NULL]\n  rm(P)\n  \n  # Plafonds annuels (plafonds mensuels reste à implémenter)\n  # AG 58 800\n  # ADTHC 55 200\n  # ADT   49 800\n  # D/ATP 25 800\n  # SM/AT 20 100\n\n#'  \n#'&nbsp;*Tableau `r incrément()` : rappel des plafonds annuels de la PFR*   \n#'      \n  \n  Tableau(c(\"Adm. général\", \"Adm. HC\", \"Adm.\", \"Direct./Attaché princ.\", \"Secr. mairie/Attaché\"),\n          sapply(PFR.plafonds <<- list( admin.g = 58800, admin.hc = 55200, admin = 49800, attaché.p = 25800, attaché = 20100), \n                 function(x) formatC(x, format = \"fg\", big.mark = \" \")))\n  #'   \n  \n  e <- c(expression.rég.admin.g, expression.rég.admin.hc, expression.rég.admin, expression.rég.attaché.p, expression.rég.attaché)\n  \n  test.PFR <- function(i, grade, cumul) { grepl(e[i], grade, perl = TRUE, ignore.case = TRUE) & (cumul > PFR.plafonds[[i]]) }\n  test.PFR.all <- function(grade, cumul) any(sapply(1:length(e), function(i) test.PFR(i, grade, cumul)))\n  \n  dépassements.PFR.boolean <- mapply(test.PFR.all, bénéficiaires.PFR$Grade, bénéficiaires.PFR$Cumul.PFR.IFTS, USE.NAMES=FALSE)\n\n  dépassements.PFR.plafonds <- data.frame()\n  \n  if (length(dépassements.PFR.boolean) > 0)\n    dépassements.PFR.plafonds <- bénéficiaires.PFR[dépassements.PFR.boolean]\n  \n  if (nrow(dépassements.PFR.plafonds) > 0) {\n    \n    cat(\"\\nLes plafonds annuels de la PFR sont dépassés pour \", nrow(dépassements.PFR.plafonds), \" cumuls annuels.\\n\")\n    kable(dépassements.PFR.plafonds, align = 'r', row.names = FALSE)\n  } else {\n    cat(\"\\nLes plafonds annuels de la PFR de sont pas dépassés.\\n\")\n  }\n    \n  bénéficiaires.PFR.Variation <- bénéficiaires.PFR[ , .(Années = paste(Année, collapse=\", \"), \n                                  `Variation (%)`= round((Cumul.PFR.IFTS[length(Année)]/Cumul.PFR.IFTS[1] - 1) * 100, 1),\n                                   `Moyenne géométrique annuelle(%)`= round(((Cumul.PFR.IFTS[length(Année)]/Cumul.PFR.IFTS[1])^(1/(length(Année) - 1)) - 1) * 100, 1)),\n                                   by=\"Nom,Matricule\"]\n  \n  bénéficiaires.PFR.Variation <- bénéficiaires.PFR.Variation[`Variation (%)` != 0.00]\n\n#'  \n#'&nbsp;*Tableau `r incrément()`* : Valeurs de l'agrégat (PFR ou IFTS) pour les bénéficiaires de la PFR   \n#'          \n\n  if (nrow(bénéficiaires.PFR)) {\n    bénéficiaires.PFR$Cumul.PFR.IFTS <- formatC(bénéficiaires.PFR$Cumul.PFR.IFTS, big.mark = \" \", format=\"fg\")\n    setnames(bénéficiaires.PFR, \"Cumul.PFR.IFTS\", \"Cumul PFR ou IFTS\")\n    kable(bénéficiaires.PFR, align = 'r', row.names = FALSE)\n  } else {\n    cat(\"\\nAucun bénéficiaire de la PFR détecté.\\n\")\n  }\n  \n#'  \n#'&nbsp;*Tableau `r incrément()`* : Variations de l'agrégat (PFR ou IFTS) pour les bénéficiaires de la PFR\n#'          \n  if (nrow(bénéficiaires.PFR.Variation)) {\n    kable(bénéficiaires.PFR.Variation, align = 'r', row.names = FALSE)\n  } else {\n    cat(\"\\nAucun tableau de variation.\\n\")\n  }\n  \n#'         \n\n#'   \n#'[Lien vers la base de données agrégat PFR-IFTS](Bases/Rémunérations/bénéficiaires.PFR.csv)    \n#'\n#'   \n#'[Lien vers la base de données variations agrégat PFR-IFTS](Bases/Rémunérations/bénéficiaires.PFR.Variation.csv)    \n#'\n\n  \n#### HEURES SUP ####\n#'\n#'## `r chapitre`.6 Contrôle sur les heures supplémentaires\n\n# Sont repérées comme heures supplémentaires ou complémentaires les heures dont le libellé obéissent à\n# l'expression régulière expression.rég.heures.sup donnée par le fichier prologue.R\n\n# Vérification des seuils annuels :\n\nDépassement.seuil.180h <- unique(Bulletins.paie[cumHSup > 180, \n                                                  .(Matricule, Année, \"Cumul heures sup\" = cumHSup, Emploi, Grade, Service)])\n  \nnb.agents.dépassement  <- uniqueN(Dépassement.seuil.180h$Matricule)\n\nif  (nb.agents.dépassement)  {\n  cat(\"Le seuil de 180 heures supplémentaires maximum est dépassé par \", FR(nb.agents.dépassement), \" agents.\\n\")\n  Dépassement.seuil.220h <- Dépassement.seuil.180h[\"Cumul heures sup\" > 220]\n  nb.agents.dépassement.220h <- uniqueN(Dépassement.seuil.220h$Matricule) \n  \n  if  (nb.agents.dépassement.220h) cat(\" Le seuil de 220 heures supplémentaires maximum est dépassé par \", FR(nb.agents.dépassement.220h), \" agents.\\n\") \n}\n\ncolonnes <- c(étiquette.matricule,\n              étiquette.année,\n              \"Mois\",\n              \"Statut\",\n              \"Libellé\",\n              étiquette.code,\n              \"Heures\",\n              \"Heures.Sup.\",\n              \"Base\",\n              \"Taux\",\n              \"Montant\",\n              \"Type\",\n              \"Service\",\n              \"Emploi\",\n              \"Grade\")\n\nHS.sup.25 <- Paie[Heures.Sup. > 25, colonnes, with=FALSE]\n\n#setkey(HS.sup.25, Type)\n\nHS.sup.indiciaire.mensuel <- HS.sup.25[Type == \"T\", .(Matricule, Année, Mois, Montant)]\n\nHS.sup.25 <-  HS.sup.25[Type %chin% c(\"I\", \"T\", \"R\", \"S\", \"IR\", \"A\")\n                          & ! grepl(\".*SMIC.*\",\n                                    Libellé, \n                                    ignore.case = TRUE)\n                          & grepl(expression.rég.heures.sup,\n                                  Libellé,\n                                  ignore.case = TRUE,\n                                  perl=TRUE), ]\n\nHS.sup.25 <- HS.sup.25[order(Matricule, Année, Mois), ]\n\n# La méthode data.table est beaucoup plus efficiente\n\ntraitement.indiciaire.mensuel <- HS.sup.indiciaire.mensuel[ ,  sum(Montant, na.rm = TRUE), \n                                                               by=\"Matricule,Année,Mois\"]\nnames(traitement.indiciaire.mensuel)[4] <- \"Traitement indiciaire mensuel\" \n  \nHS.sup.25 <- merge(HS.sup.25, traitement.indiciaire.mensuel, by=c(\"Matricule\", \"Année\", \"Mois\"))\n\nHS.sup.25 <- merge(HS.sup.25, Analyse.rémunérations[ , .(Matricule, Année, traitement.indiciaire)], \n                                                       by=c(\"Matricule\", \"Année\"))\n\nHS.sup.25 <- unique(HS.sup.25, by=NULL)\n\nnames(HS.sup.25) <- sub(\"traitement.indiciaire\", \"Traitement indiciaire annuel\", names(HS.sup.25))\n\nnombre.Lignes.paie.HS.sup.25 <- nrow(HS.sup.25)\n\nihts.anormales <- data.frame(NULL)\n\nif (fichier.personnels.existe)\n  nombre.ihts.anormales <- nrow(ihts.anormales) else nombre.ihts.anormales <- NA\n\nif (! is.null(HS.sup.25)) message(\"Heures sup controlées\")\n#'\n#'  \n#'&nbsp;*Tableau `r incrément()`*   \n#'    \n\nTableau(c(\"Nombre de lignes HS en excès\", \"Nombre de lignes IHTS anormales\"), nombre.Lignes.paie.HS.sup.25, nombre.ihts.anormales)\n\n#'\n#'[Lien vers la base de données Heures supplémentaires en excès du seuil de 25h/mois](Bases/Réglementation/HS.sup.25.csv)     \n#'[Lien vers la base de données cumuls en excès des seuils annuels](Bases/Réglementation/Dépassement.seuil.180h.csv)    \n#'[Lien vers la base de données IHTS anormales](Bases/Réglementation/ihts.anormales.csv)      \n#'\n#'**Nota :**   \n#'HS en excès : au-delà de 25 heures par mois     \n#'IHTS anormales : non attribuées à des fonctionnaires de catégorie B ou C.     \n\n#### ELUS ####\n\n#' \n#'## `r chapitre`.7 Contrôle sur les indemnités des élus\n#'   \n\nrémunérations.élu <- Analyse.rémunérations[ indemnités.élu > minimum.positif,\n                                            c(clé.fusion,\n                                              \"Année\",\n                                              \"Emploi\",\n                                              \"indemnités.élu\",\n                                              \"autres.rémunérations\",\n                                              \"rémunération.indemnitaire.imposable\"),\n                                            with=FALSE ]\n\nrémunérations.élu[ , rémunération.indemnitaire.imposable := indemnités.élu +  rémunération.indemnitaire.imposable]\n\nrémunérations.élu <- merge(unique(matricules[ , .(Nom,  Matricule)], by=NULL),\n                             rémunérations.élu,\n                             by = étiquette.matricule,\n                             all.y = TRUE,\n                             all.x = FALSE)\n\nnames(rémunérations.élu) <- c(union(clé.fusion, \"Nom\"),\n                              \"Année\",\n                              \"Emploi\",\n                              \"Indemnités \",\n                              \"Autres \",\n                              \"Total \")\n\nrémunérations.élu <- na.omit(rémunérations.élu)\n\n#'   \nif (générer.table.élus)   {\n  \n    if (nrow(rémunérations.élu) > 0) {\n      \n      kable(rémunérations.élu, row.names = FALSE)\n      \n    } else {\n  \n      cat(\"Tableau des indemnités d'élu : pas de données.\")\n    } \n} else {\n\n   cat(\"Tableau des indemnités d'élu : non générée.\")\n}\n\n\nif (sauvegarder.bases.analyse)\n  Sauv.base(file.path(chemin.dossier.bases, \"Effectifs\"),\n            \"matricules\",\n            fichier.personnels)\n\n#'[Lien vers la base de données Rémunérations des élus](Bases/Réglementation/rémunérations.élu.csv)\n#'\n\n#### COMPTE DE GESTION ####\n\n#'## `r chapitre`.8 Lien avec le compte de gestion\n \n\ncumul.lignes.paie <- Paie[Type %chin% c(\"T\", \"I\", \"R\", \"IR\", \"S\", \"A\", \"AC\") , \n                        .(Total = sum(Montant, na.rm = TRUE)), keyby=\"Année,Type,Libellé,Code\"]\n\ncumul.lignes.paie <- cumul.lignes.paie[Total != 0]\n\ncumul.lignes.paie[  Type == \"R\",\n                   Type := \"Rappels\"\n               ][\n                   Type == \"T\", \n                   Type := \"Traitements\"\n               ][\n                   Type == \"I\", \n                   Type := \"Indemnités\"\n               ][\n                   Type == \"IR\",\n                   Type := \"Indem. Résidence\"\n               ][ \n                   Type == \"S\",\n                   Type := \"Supplément familial\"\n               ][\n                   Type == \"A\",\n                   Type := \"Rém. diverses\"\n               ][\n                   Type == \"AC\", \n                   Type := \"Acomptes\"\n                   \n               ][ , Total2  := formatC(Total, big.mark = \" \", format = \"f\", decimal.mark = \",\", digits = 2)]\n\n\ncumul.total.lignes.paie <- cumul.lignes.paie[ , .(`Cumul annuel`= formatC(sum(Total, na.rm = TRUE), big.mark = \" \", format = \"f\", decimal.mark = \",\", digits = 2)), \n                                                keyby = \"Année,Type\"]\n\nsetnames(cumul.lignes.paie[ , Total := NULL], \"Total2\", \"Total\")\n\nL <- split(cumul.lignes.paie, cumul.lignes.paie$Année)\n\n  \n\nif (afficher.cumuls.détaillés.lignes.paie) {\n  for (i in 1:durée.sous.revue) {\n    cat(\"\\nTableau \", incrément(), \" Année \", début.période.sous.revue + i - 1)\n    print(kable(L[[i]][, .(Catégorie = Type, Code, Libellé, Total)], row.names = FALSE, align = 'r'))\n    incrément()\n  }\n}\n\nL <- split(cumul.total.lignes.paie, cumul.total.lignes.paie$Année)\n\n#'  \n#'Cumul des lignes de paie par exercice et catégorie de ligne de paie   \n#'  \n\n\nfor (i in 1:durée.sous.revue) {\n  cat(\"\\nTableau \", incrément(), \" Année \", début.période.sous.revue + i - 1)\n  print(kable(L[[i]][, .(Catégorie = Type, `Cumul annuel`)], row.names = FALSE, align = 'r'))\n\n}\n\nrm(L)\n\n#'  \n#'[Lien vers la base détaillée des cumuls des lignes de paie](Bases/Réglementation/cumul.lignes.paie.csv)\n#'  \n#'[Lien vers la base agrégée des cumuls des lignes de paie](Bases/Réglementation/cumul.total.lignes.paie.csv)\n#'  \n\n#'  \n#'*Avertissement : les rappels comprennent également les rappels de cotisations et déductions diverses.*    \n#'   \n\n#### SFT ####\n\n#'\n#'## `r chapitre`.9 Contrôle du supplément familial de traitement   \n#'  \n\n# on prévoit 15 enfants...\n\n# limitations : pas de vérification des cas de divorce etc., ni des cas de cumuls\n#               pas de vérification non plus de la licéité des versements à des contractuels exclus par l'article 1er \n#               du décret n°85-1148 du 24 octobre 1985 modifié relatif à la rémunération des personnels civils et militaires\n#               de l'Etat, des personnels des collectivités territoriales et des personnels des établissements publics d'hospitalisation. \n\n# part fixe mensuelle\n\nsft.fixe <- c(un = 2.29, deux = 10.67, trois = 15.24, 15.24 + 4.57 * 1:12)\n\n# part variable en proportion du traitement indiciaire\n\nsft.prop <- c(un = 0, deux = 3, trois = 8, 8 + 6 * 1:12) / 100 \n\npart.proportionnelle.minimale <- outer(PointMensuelIM, sft.prop * 449)\n\n\nsft <- function(x, indice, nbi, durée, année, mois)   {\n\n#    if (is.na(x) || x <= 0 || is.na(indice)) return(0)\n  \n    if (x > 15) return(-1)\n  \n    if (is.na(durée) || is.na(x) || is.na(indice)) return(0)\n  \n    if (grepl(\"H.*(E|é).*[A-F]\", indice, perl = TRUE, ignore.case = TRUE)) {\n      \n        indice <- 717\n        \n    } else {\n    \n        indice <- as.numeric(indice)\n    }\n  \n    indice <- sum(indice, nbi, na.rm = TRUE)\n    \n    part.proportionnelle <- (x != 0) * sft.prop[x] * max(449, min(indice, 717)) * PointMensuelIM[année - 2007, mois]  \n    \n    # on prend en compte les quotités spécifiques de temps partiel\n    \n    if (durée == 90) {\n           coef <- 0.91429   # 32/35 \n    } else if (durée == 80) {\n           coef <- 0.85714   # 6/7   \n    } else coef <- durée/100\n                    \n    if (x != 1) {\n      \n     valeur <- coef * (part.proportionnelle + sft.fixe[x]) \n     \n    } else {\n      \n     valeur <- coef * part.proportionnelle + sft.fixe[x]\n    }\n    \n    # vérification du plancher des attributions minimales à temps plein\n    \n    if (x != 1) \n            valeur <- max(valeur, part.proportionnelle.minimale[ , , x][année - 2007, mois] + sft.fixe[x])\n    \n    \n    #if (is.na(valeur)) valeur <- 0\n    \n    return(valeur)\n\n  }\n\nPaie.sans.enfant <- Paie[is.na(NbEnfants) | NbEnfants == 0]\n\nPaie.sans.enfant.réduit <- Paie.sans.enfant[ , .(SFT.versé = sum(Montant[Type == \"S\"], na.rm = TRUE)), keyby=\"Matricule,Année,Mois\"] \n\nPaie.sans.enfant.réduit <- Paie.sans.enfant.réduit[SFT.versé > 0, ]\n\nnb.écart.paiements.sft.sans.enfant <- nrow(Paie.sans.enfant.réduit)\n\nif (nb.écart.paiements.sft.sans.enfant > 0){\n  \n  cat(\"\\nPour les agents n'ayant pas d'enfant signalé en base, il a été détecté \",\n      nb.écart.paiements.sft.sans.enfant,\n      \" bulletin\", ifelse(nb.écart.paiements.sft.sans.enfant == 1, \"\", \"s\"),\n      \" de paie présentant un paiement du SFT apparemment anormal.\\n\", sep=\"\")  \n  \n  if (afficher.table.écarts.sft)\n    kable(Paie.sans.enfant.réduit, row.names = FALSE, align = 'c')\n  \n} else {\n  \n  cat(\"\\nPour les agents n'ayant pas d'enfant signalé en base, il n'a été détecté aucun paiement de SFT.\\n\")\n  \n}\n\n#'  \n#'[Lien vers la base des paiements de SFT à agents sans enfant signalé](Bases/Réglementation/Paie.sans.enfant.réduit.csv)\n#'  \n\nPaie.enfants <- Paie[!is.na(NbEnfants) & NbEnfants > 0 & !is.na(Indice) & !is.na(Heures)]\n\nPaie.enfants.réduit <- Paie.enfants[ , .(SFT.versé = sum(Montant[Type == \"S\"], na.rm = TRUE), \n                                        #Traitement = sum(Montant[Type == \"T\"], na.rm = TRUE),\n                                        Temps.de.travail = Temps.de.travail[1],\n                                        Indice = Indice[1],\n                                        NBI = NBI[1],\n                                        NbEnfants = NbEnfants[1]),\n                                        keyby=\"Matricule,Année,Mois\"]\n\nSFT.controle <- with(Paie.enfants.réduit, \n                     mapply(sft, NbEnfants, Indice, NBI, Temps.de.travail, Année, Mois, USE.NAMES = FALSE))\n\nPaie.enfants.réduit <- cbind(Paie.enfants.réduit, SFT.controle)\n\nPaie.enfants.réduit[ , delta.SFT := SFT.versé - SFT.controle]\n\n## Attention ne pas intégrer au sein d'un même `:=`(...) deux définitions en coréférence avec if ... else \n# ou alors utiliser ifelse()  [bug de data.table]\n\n#Paie.enfants.réduit[ , ecart := if (SFT.controle > 1) delta / SFT.controle else NA]\n\n# On accepte un tolérance fixée dans prologue.R à tolérance.sft <- 1 euro\n\ncontrole.sft <- Paie.enfants.réduit[delta.SFT > tolérance.sft, \n                                      .(delta.SFT = round(delta.SFT, 2),\n                                       SFT.versé,\n                                       SFT.controle = round(SFT.controle, 2),\n                                       Matricule, \n                                       Année,\n                                       Mois,\n                                       Indice,\n                                       NBI,\n                                       Temps.de.travail,\n                                       NbEnfants)]\n\nnb.écart.paiements.sft <- nrow(controle.sft)\n\nif (nb.écart.paiements.sft) setorder(controle.sft, -delta.SFT, Matricule, Année, Mois)\n\nif (nb.écart.paiements.sft > 0){\n    \n  cat(\"\\nPour les agents ayant au moins un enfant, il a été détecté \",\n      nb.écart.paiements.sft,\n      \" bulletin\", ifelse(nb.écart.paiements.sft == 1, \"\", \"s\"),\n      \" de paie présentant un écart de paiement du SFT supérieur à \", tolérance.sft, \" euro.\\n\", sep=\"\")  \n\n  if (afficher.table.écarts.sft)\n     kable(controle.sft, row.names = FALSE, align = 'c')\n    \n} else {\n  \n  cat(\"\\nPour les agents ayant au moins un enfant, il n'a été détecté aucun écart de paiement sur SFT supérieur à \", tolérance.sft, \" euro.\\n\")\n      \n}\n\n#'  \n#'[Lien vers la base des écarts de paiement sur SFT](Bases/Réglementation/controle.sft.csv)\n#'  \n\nmessage(\"Analyse du SFT\")\n\n# data.table here overallocates memory hence inefficient !\n# Bulletins.paie[NbEnfants > 0 , SFT.controle := sft(NbEnfants, Indice, Heures, Année, Mois)]\n       \n#### ANNEXE ####\n\n#'# Annexe\n#'## Liens complémentaires\n\n#'\n#'[Lien vers le fichier des personnels](Bases/Effectifs/Catégories des personnels.csv)\n#'  \n#'## Fiabilité du traitement statistique   \n#'*Doublons*      \n\nif (éliminer.duplications) {\n  if (après.redressement != avant.redressement) {\n        \n    cat(\"Retraitement de la base de lignes de paie : \")\n  \n  } else {\n    cat(\"Aucune duplication de ligne de paie n'a été détectée. \")\n  }\n \n} else {\n  \n    if (anyDuplicated(Paie) || anyDuplicated(Bulletins.paie)) {\n      cat(\"Attention : Altaïr a détecté des lignes dupliquées alors qu'aucun retraitement des lignes dupliquées n'est prévu par défaut.\")\n    } else {\n      cat(\"Aucune duplication de ligne n'a été détectée. \")\n    }\n}\n\n#'  \nif (après.redressement != avant.redressement)\n  cat(\"Elimination de \", FR(avant.redressement - après.redressement), \" lignes dupliquées\")\n#'  \n#'*Tests de fiabilité sur le renseignement des heures et des quotités*    \n#'   \nmessage(\"Bulletins de Paie retraités\")\n\nnrow.bull <- nrow(Bulletins.paie)\nnrow.bull.heures <- nrow(Bulletins.paie[Heures != 0])\nnrow.bull.quotités <- nrow(Bulletins.paie[Temps.de.travail != 0])\n\nif (nrow.bull.heures/nrow.bull  < 0.1) \n  message(\"Attention moins de 10 % des heures sont renseignées\")\n\nif (nrow.bull.quotités/nrow.bull < 0.1)\n  message(\"Attention moins de 10 % des quotités sont renseignées\")\n#'     \ncat(\"Nombre de bulletins : \", FR(nrow.bull))\n#'     \nif (redresser.heures) {\n  if (nredressements > 0) {\n    cat(\"Les heures de travail ont été redressées avec la méthode \", ifelse(test.temps.complet, \"des quotités.\\n\", \"de l'interpolation indiciaire\\n\")) \n  }\n} else {\n   cat(\"Les heures de travail n'ont pas été redressées.\")\n}\n#'    \ncat(\" Nombre de bulletins de paie redressés :\", FR(nredressements)) \n#'    \ncat(\" Pourcentage de redressements :\", round((nredressements)/nrow.bull*100, 2), \"% des bulletins de paie.\")\n#'  \ncat(\"\\nPourcentage d'heures renseignées (après redressement éventuel):\", round(nrow.bull.heures/nrow.bull*100, 1), \"%\")\n#'   \ncat(\"\\nPourcentage de quotités renseignées :\", round(nrow.bull.quotités/nrow.bull*100, 1), \"%\")\n#'   \ncat(\"\\nNombre de bulletins à heures et quotités : \", n <- nrow(Bulletins.paie[Heures != 0 & Temps.de.travail != 0]), \"[\", round(n/nrow.bull*100, 1), \"%]\")\n#'   \ncat(\"\\nNombre de bulletins à heures sans quotités : \", n <- nrow(Bulletins.paie[Heures != 0 & Temps.de.travail == 0]), \"[\", round(n/nrow.bull*100, 1), \"%]\")\n#'   \ncat(\"\\nNombre de bulletins à quotités sans heures : \", n <- nrow(Bulletins.paie[Heures == 0 & Temps.de.travail != 0]), \"[\", round(n/nrow.bull*100, 1), \"%]\")\n#'   \ncat(\"\\nNombre de bulletins apparemment inactifs : \", n <- nrow(Bulletins.paie[Heures == 0 & Temps.de.travail == 0]), \"[\", round(n/nrow.bull*100, 1), \"%]\")\n#'   \ncat(\"\\nNombre de bulletins non renseignés pour les heures ou les quotités: \", n <- nrow(Bulletins.paie[is.na(Heures) | is.na(Temps.de.travail)]), \"[\", round(n/nrow.bull*100, 1), \"%]\")\n#'   \nbase.heures.nulles.salaire.nonnull     <- Bulletins.paie[Heures == 0  & (Net.à.Payer != 0 | Brut != 0)]\nbase.quotité.indéfinie.salaire.nonnull <- Bulletins.paie[MHeures == 0 & (Net.à.Payer != 0 | Brut != 0)]\n\nnligne.base.heures.nulles.salaire.nonnull     <- nrow(base.heures.nulles.salaire.nonnull)\nnligne.base.quotité.indéfinie.salaire.nonnull <- nrow(base.quotité.indéfinie.salaire.nonnull)\n#'  \nif (nligne.base.heures.nulles.salaire.nonnull)\n   cat(\"Nombre de bulletins de paie de salaires versés pour un champ Heures = 0 : \", FR(n <<- nligne.base.heures.nulles.salaire.nonnull), \"[\", round(n/nrow.bull * 100, 1), \"%]\")\n#'   \nif (nligne.base.quotité.indéfinie.salaire.nonnull)\n   cat(\"\\nNombre de bulletins de paie de salaires versés pour une quotité de travail indéfinie : \", FR(nligne.base.heures.nulles.salaire.nonnull))\n#'   \n#'[Lien vers la base de données des salaires versés pour Heures=0](Bases/Fiabilité/base.heures.nulles.salaire.nonnull.csv)   \n#'[Lien vers la base de données des salaires versés à quotité indéfinie](Bases/Fiabilité/base.quotité.indéfinie.salaire.nonnull.csv)   \n#'\n#'# Tableau des personnels : renseigner la catégorie\n#'\n#'Utiliser les codes : A, B, C, ELU, AUTRES\n#'\n#'En cas de changement de catégorie en cours de période, utiliser la catégorie AUTRES\n#'Cela peut conduire à modifier manuellement le fichier Catégories des personnels.csv\n#'\nif (générer.table.effectifs) {\n  kable(matricules, row.names = FALSE) \n} else  {\n  cat(\"\\nNon généré  [anonymisation]\\n\")\n}\n\n# ------------------------------------------------------------------------------------------------------------------\n#  Sauvegardes : enlever les commentaires en mode opérationnel\n##\n\nif (sauvegarder.bases.analyse) {\n\n  sauv.bases(file.path(chemin.dossier.bases, \"Rémunérations\"),\n             \"Analyse.rémunérations\",\n             \"Analyse.variations.synthèse\",\n             \"Analyse.variations.par.exercice\",\n             \"masses.premier.personnels\",\n             \"masses.premier.élus\",\n             \"masses.dernier.personnels\",\n             \"masses.dernier.élus\",\n             \"bénéficiaires.PFR\",\n             \"bénéficiaires.PFR.Variation\")\n\n  sauv.bases(file.path(chemin.dossier.bases, \"Effectifs\"),\n             \"Bulletins.paie.nir.total.hors.élus\",\n             \"Bulletins.paie.nir.fonctionnaires\",\n             \"Bulletins.paie.nir.nontit\",\n             \"Bulletins.paie.nir.permanents\",\n             \"tableau.effectifs\")\n\n  sauv.bases(file.path(chemin.dossier.bases, \"Réglementation\"),\n             \"personnels.iat.ifts\",\n             \"codes.ifts\",\n             \"personnels.pfr.ifts\",\n             \"codes.pfr\",\n             \"HS.sup.25\",\n             \"Dépassement.seuil.180h\",\n             \"ifts.et.contractuel\",\n             \"ihts.anormales\",\n             \"lignes.contractuels.et.vacations\",\n             \"lignes.fonctionnaires.et.vacations\",\n             \"lignes.ifts.anormales\",\n             \"matricules.contractuels.et.vacations\",\n             \"matricules.fonctionnaires.et.vacations\",\n             \"NBI.aux.non.titulaires\",\n             \"personnels.prime.informatique\",\n             \"personnels.iat.ifts\",\n             \"rémunérations.élu\",\n             \"RI.et.vacations\",\n             \"traitement.et.vacations\",\n             \"cumul.lignes.paie\",\n             \"cumul.total.lignes.paie\",\n             \"controle.sft\",\n             \"Paie.sans.enfant.réduit\")\n  \n  sauv.bases(file.path(chemin.dossier.bases, \"Fiabilité\"),\n              \"base.heures.nulles.salaire.nonnull\",\n              \"base.quotité.indéfinie.salaire.nonnull\",\n              \"lignes.nbi.anormales\",\n              \"cumuls.nbi\")\n  \n}\n\nif (sauvegarder.bases.origine)\n  sauv.bases(file.path(chemin.dossier.bases, \"Paiements\"),\n             \"Paie\",\n             \"Bulletins.paie\")\n\nif (! générer.rapport)\n   setwd(currentDir)\n\nmessage(getwd())\n",
    "created" : 1447886013510.000,
    "dirty" : false,
    "encoding" : "ISO8859-1",
    "folds" : "",
    "hash" : "3803731214",
    "id" : "ECF84A80",
    "lastKnownWriteTime" : 1447889238,
    "path" : "C:/Users/Public/Dev/altair/Tests/Exemple/altair.R",
    "project_path" : "Tests/Exemple/altair.R",
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}